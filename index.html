<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff">
    <meta name="apple-mobile-web-app-title" content="Turni 2026">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="icon" type="image/svg+xml" href="icon.svg">

    <title>TURNI AUTISTI 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- RESET E BASE --- */
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        
        :root {
            --primary: #2563eb; 
            --bg: #f8fafc;
            --header-h: 155px;        
            --cell-h: 82px;             
            --font-base: 0.95rem;       
            --font-small: 0.75rem;      
            --th-h: 44px;               
            
            /* --- PALETTE COLORI ORIGINALI --- */
            --c-M: #a0c7ff; --t-M: #024e74; --b-M: #bae6fd;
            --c-P: #c6defd; --t-P: #024e74; --b-P: #c7d2fe;
            --c-N: #69a7ff; --t-N: #024e74; --b-N: #c7d2fe;
            --c-D-day: #fff1f2; --t-D-day: #4b5563; --b-D-day: #ff9baf83;
            --c-R: #ecfdf5; --t-R: #059669; --b-R: #6ee7b7;
            --c-SM: #3a8cff; --t-SM: #004567; --b-SM: #cbd5e1;

            --bg-ferie: #f99214; --t-ferie: #f4e7e2; --b-ferie: #a15300;
            --bg-perm: #38cf65; --t-perm: #efefef; --b-perm: #004e1c;
            --bg-cong: #f0dc00; --t-cong: #fffbf6; --b-cong: #9a8000;
            --bg-rec: #fe74c0; --t-rec: #ffe8f2; --b-rec: #7f0046;
            
            --bg-fest: #f0f9ff; --t-fest: #0284c7; --b-fest: #7dd3fc;
            --bg-mal: #fef2f2; --t-mal: #dc2626; --b-mal: #fca5a5;
        }

        body.desktop-view {
            --header-h: 120px;
            --cell-h: 55px;
            --font-base: 0.85rem;
            --font-small: 0.7rem;
            --th-h: 35px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); margin: 0; padding-top: var(--header-h); 
            color: #0f172a; transition: all 0.3s ease; overscroll-behavior-y: none; 
        }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.03);
            z-index: 1000; height: var(--header-h);
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: height 0.3s ease;
        }
        
        .top-bar { padding: 0 16px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; }
        .logo { font-size: 1.3rem; font-weight: 800; color: var(--primary); display: flex; align-items: center; gap: 8px; letter-spacing: -0.5px; }
        .right-controls { display: flex; gap: 8px; position: relative; }

        .btn-action { 
            background: #f8fafc; color: #475569; border: 1px solid #e2e8f0; padding: 8px 12px; 
            border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 0.75rem; 
            display: flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .btn-action:active { transform: scale(0.96); }
        
        /* MENU DROPDOWN */
        #menu-dropdown { 
            position: absolute; top: 50px; right: 0; background: white; 
            border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            width: 220px; overflow: hidden; display: none; border: 1px solid #e2e8f0; 
            flex-direction: column; z-index: 5000;
        }
        #menu-dropdown.open { display: flex; animation: fadeIn 0.2s ease; }
        .menu-item { padding: 15px 20px; display: flex; align-items: center; gap: 12px; font-weight: 700; color: #334155; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: 0.2s; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: #f8fafc; }
        .menu-item span { color: var(--primary); }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        /* SCROLLERS */
        .nav-scroller, .driver-scroller { flex: 1; display: flex; gap: 8px; overflow-x: auto; padding: 0 16px; align-items: center; scrollbar-width: none; }
        .nav-scroller { border-bottom: 1px solid #f1f5f9; }
        
        .chip { 
            padding: 8px 18px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; 
            white-space: nowrap; cursor: pointer; transition: 0.2s; 
            display: flex; align-items: center; justify-content: center;
        }
        
        .chip-month { background: white; color: #64748b; border: 1px solid #e2e8f0; }
        .chip-month.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 12px rgba(37, 99, 235, 0.25); }
        
        .chip-driver { background: #f1f5f9; color: #64748b; border: 1px solid #e2e8f0; }
        .chip-driver.active { background: #1e293b; color: white; border-color: #1e293b; box-shadow: 0 4px 12px rgba(30, 41, 59, 0.25); }

        /* TABLE */
        .container { padding: 0; max-width: 100%; margin: 0 auto; padding-bottom: 40px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }

        thead th {
            background: #f8fafc; color: #64748b; padding: 5px; font-size: 0.75rem; 
            text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px;
            position: sticky; top: var(--header-h); z-index: 90; 
            border-bottom: 1px solid #cbd5e1; text-align: center; min-width: 115px;
            height: var(--th-h); transition: top 0.3s ease;
        }
        thead th:first-child, .td-date { width: 60px !important; min-width: 60px !important; max-width: 60px !important; }

        tr.month-header td {
            background: var(--primary); color: white; font-weight: 800; 
            font-size: 1.5rem;
            text-transform: uppercase; letter-spacing: 0px;
            position: sticky; top: calc(var(--header-h) + var(--th-h)); z-index: 85; 
            box-shadow: 0 8px 20px rgba(37, 99, 235, 0.15); transition: top 0.3s ease; 
            padding: 0; border: none;
            line-height: 1.2;
        }
        .sticky-month-text { 
            position: sticky; left: 0; width: 100vw; 
            text-align: left; 
            padding: 4px 0 4px 12px;
            display: flex; 
            align-items: baseline;
            gap: 12px;
        }

        tbody td { 
            padding: 4px; height: var(--cell-h); vertical-align: middle; 
            border-bottom: 1px solid #f1f5f9; border-right: 1px dashed #e2e8f0; 
            transition: height 0.3s ease;
        }
        
        .td-date { 
            text-align: center; font-weight: 800; color: #334155; font-size: 1.2rem; 
            border-right: 2px solid #cbd5e1; background: #f8fafc;
            position: sticky; left: 0; z-index: 80;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: var(--cell-h); 
        }
        .td-date small { display: block; font-weight: 600; font-size: 0.75rem; text-transform: uppercase; color: #94a3b8; margin-top: 2px; }
        
        .td-date.date-red { color: #dc2626; background: #fef2f2; border-right-color: #fca5a5; }
        .td-date.date-red small { color: #ef4444; }
        .holiday-name { font-size: 0.55rem; color: #dc2626; font-weight: 900; line-height: 1; margin-top: 3px; max-width: 55px; white-space: normal; }

        .cell { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100%; width: 100%; border-radius: 12px; font-weight: 800; 
            font-size: var(--font-base); text-transform: uppercase; position: relative; 
            line-height: 1.2; text-align: center; cursor: pointer;
            box-shadow: 0 2px 0 rgba(0,0,0,0.02);
        }
        
        .time-tag { font-size: var(--font-small); font-weight: 600; opacity: 0.8; margin-top: 2px; letter-spacing: -0.3px; }
        .rep-badge { font-size: 0.65rem; color: #dc2626; margin-top: 3px; font-weight: 900; background: #fef2f2; padding: 2px 8px; border-radius: 6px; border: 1px solid #fca5a5; box-shadow: 0 1px 2px rgba(0,0,0,0.05); letter-spacing: 0.5px; }

        .t-M { background: var(--c-M); color: var(--t-M); border: 1px solid var(--b-M); }
        .t-P { background: var(--c-P); color: var(--t-P); border: 1px solid var(--b-P); }
        .t-N { background: var(--c-N); color: var(--t-N); border: 1px solid var(--b-N); }
        .t-R { background: var(--c-R); color: var(--t-R); border: 1px solid var(--b-R); }
        .t-SM { background: var(--c-SM); color: var(--t-SM); border: 1px solid var(--b-SM); }
        .t-diurno { background: var(--c-D-day) !important; color: var(--t-D-day) !important; border: 1px solid var(--b-D-day) !important; }

        .spec-orange { background: var(--bg-ferie); color: var(--t-ferie); border: 1px solid var(--b-ferie); font-size: 0.7rem; }
        .spec-green { background: var(--bg-perm); color: var(--t-perm); border: 1px solid var(--b-perm); font-size: 0.7rem; }
        .spec-yellow { background: var(--bg-cong); color: var(--t-cong); border: 1px solid var(--b-cong); font-size: 0.7rem; }
        .spec-pink { background: var(--bg-rec); color: var(--t-rec); border: 1px solid var(--b-rec); font-size: 0.7rem; }
        
        .spec-blue { background: #e0f2fe !important; color: #0369a1 !important; border: 1px solid #7dd3fc !important; font-size: 0.7rem; }
        .spec-red { background: #fee2e2 !important; color: #b91c1c !important; border: 1px solid #fca5a5 !important; font-size: 0.8rem; }
        .spec-nl { background: #e0f7fa !important; color: #006064 !important; border: 1px solid #b2ebf2 !important; font-size: 0.7rem; }
        
        .empty { background: transparent; box-shadow: none; color: #cbd5e1; font-weight: 400;}

        tr.today td { background: #fff7ed !important; border-bottom: 2px solid #f97316 !important; }
        tr.today .td-date { color: #ea580c; border-left: 6px solid #ea580c; background: #fff7ed; border-right: 2px solid #f97316; }

        #loader { position: fixed; inset: 0; background: white; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px;}
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 0.8s ease-in-out infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #manual-upload { display: none; margin-top: 20px; }
        .file-label { background: var(--primary); color: white; padding: 14px 28px; border-radius: 16px; font-weight: bold; cursor: pointer; font-size: 1rem; display: inline-block; margin-top: 15px; box-shadow: 0 4px 15px rgba(37,99,235,0.4); }
        input[type="file"] { display: none; }
        
        body.desktop-view .driver-scroller { display: none; }

        /* MODALE TURNI */
        #shift-modal, #dinner-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.5); z-index: 3000; backdrop-filter: blur(4px); align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #shift-modal.open, #dinner-modal.open { opacity: 1; }
        .modal-content { background: white; width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.2); overflow: hidden; transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.1, 0.9, 0.2, 1); max-height: 80vh; display: flex; flex-direction: column; }
        #shift-modal.open .modal-content, #dinner-modal.open .modal-content { transform: translateY(0); }
        .modal-header { background: var(--bg); color: #0f172a; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; }
        .header-text h3 { margin: 0; font-size: 1.4rem; font-weight: 900; color: #1e293b; display: flex; align-items: center; gap: 10px;}
        .header-text span { display: block; font-size: 0.9rem; font-weight: 600; color: #64748b; margin-top: 4px;}
        .btn-close-modal { background: rgba(0,0,0,0.05); border: none; color: #475569; cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .modal-body { padding: 0; overflow-y: auto; }
        .colleague-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 20px; border-bottom: 1px solid #f1f5f9; }
        .c-name { font-weight: 800; color: #334155; font-size: 1rem; }
        .c-time { font-size: 0.85rem; font-weight: 600; color: #64748b; background: #f1f5f9; padding: 6px 12px; border-radius: 8px; }
        .modal-theme-M .modal-header { background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); } .modal-theme-M .header-text h3 { color: #0c4a6e; } .modal-theme-M .c-time { background: #e0f2fe; color: #0369a1; }
        .modal-theme-P .modal-header { background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); } .modal-theme-P .header-text h3 { color: #312e81; } .modal-theme-P .c-time { background: #e0e7ff; color: #4338ca; }
        .modal-theme-N .modal-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); } .modal-theme-N .header-text h3 { color: white; } .modal-theme-N .header-text span { color: #94a3b8; } .modal-theme-N .btn-close-modal { background: #334155; color: white; } .modal-theme-N .c-time { background: #f1f5f9; color: #0f172a; }
        .modal-theme-R .modal-header { background: linear-gradient(135deg, #dcfce7 0%, #ecfdf5 100%); } .modal-theme-R .header-text h3 { color: #064e3b; } .modal-theme-R .c-time { background: #dcfce7; color: #15803d; }

        /* STILI PER IL MODALE CENA */
        .dinner-checkbox-list { padding: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .dinner-check-item { background: #f8fafc; padding: 10px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; font-weight: 700; color: #475569; }
        .dinner-check-item.checked { background: #eff6ff; border-color: var(--primary); color: var(--primary); }
        .dinner-check-item input { display: none; }
        .dinner-check-icon { width: 20px; height: 20px; border-radius: 4px; border: 2px solid #cbd5e1; display: flex; align-items: center; justify-content: center; }
        .dinner-check-item.checked .dinner-check-icon { background: var(--primary); border-color: var(--primary); color: white; }
        
        .dinner-section-title { font-size: 0.8rem; font-weight: 800; color: #94a3b8; padding: 15px 20px 5px; text-transform: uppercase; }
        .month-selector { display: flex; overflow-x: auto; gap: 8px; padding: 10px 20px; scrollbar-width: none; }
        .btn-find-dinner { margin: 20px; background: #0f172a; color: white; border: none; padding: 15px; border-radius: 12px; font-weight: 800; font-size: 1rem; width: calc(100% - 40px); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-find-dinner:active { transform: scale(0.98); }
        
        /* NUOVO: SELETTORE CENA/PRANZO */
        .event-type-selector { display: flex; background: #f1f5f9; padding: 4px; border-radius: 12px; margin: 0 20px 15px; }
        .event-option { flex: 1; text-align: center; padding: 10px; border-radius: 10px; font-weight: 700; font-size: 0.9rem; color: #64748b; cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .event-option.active { background: white; color: var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        .dinner-result-card { background: white; margin: 10px 20px; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .d-res-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f1f5f9; padding-bottom: 10px; margin-bottom: 10px; }
        .d-res-date { font-weight: 800; font-size: 1.1rem; color: #1e293b; }
        .d-res-score { background: #dcfce7; color: #15803d; font-weight: 700; padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }
        .missing-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .missing-badge { background: #fee2e2; color: #b91c1c; font-size: 0.7rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
        .warning-badge { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-size: 0.7rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; display:inline-flex; align-items:center; gap:4px; }
        
        /* MODALE STATISTICHE */
        #stats-modal { display: none; position: fixed; inset: 0; background: white; z-index: 4000; flex-direction: column; overflow: hidden; }
        #stats-modal.open { display: flex; }
        .stats-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; background: #fff; }
        .stats-body { flex: 1; overflow-y: auto; padding: 20px; background: #f8fafc; }
        
        .driver-list-item { padding: 15px; border-bottom: 1px solid #e2e8f0; font-weight: 700; color: #334155; cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: white; margin-bottom: 8px; border-radius: 12px; box-shadow: 0 1px 2px rgba(0,0,0,0.02); }
        .driver-list-item:hover { background: #f1f5f9; }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 10px; }
        .stat-card { background: white; padding: 15px; border-radius: 16px; border: 1px solid #e2e8f0; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .stat-val { font-size: 1.8rem; font-weight: 900; display: block; margin-bottom: 5px; }
        .stat-lbl { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: #64748b; }
        
        /* Colori Card Statistiche (uguali alla tabella) */
        .sc-fer { color: var(--b-ferie); border-color: var(--bg-ferie); background: #fff7ed; }
        .sc-cong { color: var(--b-cong); border-color: var(--bg-cong); background: #fefce8; }
        .sc-perm { color: var(--b-perm); border-color: var(--bg-perm); background: #f0fdf4; }
        .sc-mal { color: #b91c1c; border-color: #fca5a5; background: #fef2f2; }
        .sc-fest { color: #0369a1; border-color: #7dd3fc; background: #f0f9ff; }
        .sc-rec { color: var(--b-rec); border-color: var(--bg-rec); background: #fdf2f8; }
    </style>
</head>
<body>

    <div id="loader">
        <div id="auto-loader">
            <div class="spinner"></div>
            <h3 style="color:#0f172a">Caricamento Turni...</h3>
        </div>
        <div id="manual-upload">
            <p style="color:#ef4444; font-weight:bold">⚠️ File automatico non trovato.</p>
            <label for="file-input" class="file-label">
                <span class="material-icons-round" style="vertical-align:middle; margin-right:5px">upload_file</span>
                CARICA FILE (turni.xlsx)
            </label>
            <input type="file" id="file-input" accept=".xlsx">
        </div>
    </div>

    <div id="shift-modal" onclick="closeShiftModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header" id="modal-header-bg">
                <div class="header-text">
                    <h3 id="modal-title">TITOLO</h3>
                    <span id="modal-subtitle">Data del giorno</span>
                </div>
                <button class="btn-close-modal" onclick="closeShiftModal()">
                    <span class="material-icons-round">keyboard_arrow_down</span>
                </button>
            </div>
            <div class="modal-body" id="modal-list"></div>
        </div>
    </div>

    <div id="dinner-modal" onclick="closeDinnerModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="height:90vh; max-height:90vh;">
            <div class="modal-header" style="background:#fff7ed; border-bottom-color:#ffedd5;">
                <div class="header-text">
                    <h3 style="color:#ea580c"><span class="material-icons-round">restaurant</span> ORGANIZZA USCITA</h3>
                    <span style="color:#fb923c">Trova il giorno migliore</span>
                </div>
                <button class="btn-close-modal" onclick="closeDinnerModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="background:#fff; display:flex; flex-direction:column; height:100%;">
                
                <div id="dinner-step-1">
                    <div class="dinner-section-title">1. MESE</div>
                    <div class="month-selector" id="dinner-month-list"></div>

                    <div class="dinner-section-title">2. TIPO DI USCITA</div>
                    <div class="event-type-selector">
                        <div class="event-option active" id="opt-cena" onclick="setEventType('cena', this)">
                            <span class="material-icons-round">bedtime</span> CENA (Sera)
                        </div>
                        <div class="event-option" id="opt-pranzo" onclick="setEventType('pranzo', this)">
                            <span class="material-icons-round">wb_sunny</span> PRANZO (Giorno)
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right:20px;">
                        <div class="dinner-section-title">3. SELEZIONA COLLEGHI</div>
                        <button onclick="toggleAllDrivers()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; font-size:0.8rem;">Tutti/Nessuno</button>
                    </div>
                    <div class="dinner-checkbox-list" id="dinner-driver-list"></div>

                    <button class="btn-find-dinner" onclick="calculateDinner()">
                        <span class="material-icons-round">search</span> TROVA GIORNO MIGLIORE
                    </button>
                </div>

                <div id="dinner-step-2" style="display:none; padding-bottom:30px;">
                    <div style="padding:10px 20px; display:flex; align-items:center; gap:10px; cursor:pointer;" onclick="resetDinnerStep()">
                        <span class="material-icons-round">arrow_back</span> <span style="font-weight:700">Torna indietro</span>
                    </div>
                    <div id="dinner-results-container"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="stats-modal">
        <div class="stats-header">
            <h3 style="margin:0; font-size:1.2rem; color:#1e293b;">STATISTICHE</h3>
            <button class="btn-close-modal" onclick="closeStatsModal()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="stats-body" id="stats-container">
            </div>
    </div>

    <header>
        <div class="top-bar">
            <div class="logo">
                <span class="material-icons-round" style="color:var(--primary)">calendar_month</span> 
                TURNI AUTISTI 2026
            </div>
            <div class="right-controls">
                
                <button class="btn-action" onclick="toggleMenu()">
                    <span class="material-icons-round">widgets</span> ALTRO
                </button>
                <div id="menu-dropdown">
                    <div class="menu-item" onclick="openDinnerModal()">
                        <span class="material-icons-round">restaurant</span> Organizza Uscita
                    </div>
                </div>

                <button class="btn-action btn-view" onclick="toggleView()" id="view-btn">
                    <span class="material-icons-round">smartphone</span>
                </button>
                <button class="btn-action btn-reset" onclick="location.reload()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
        <div class="nav-scroller" id="month-nav"></div>
        <div class="driver-scroller" id="driver-nav"></div>
    </header>

    <div class="container">
        <table id="main-table">
            <thead><tr id="table-head"></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        const FILE_NAME = "turni.xlsx?v=" + new Date().getTime(); 
        const MONTH_MAP = { "GENNAIO":0, "FEBBRAIO":1, "MARZO":2, "APRILE":3, "MAGGIO":4, "GIUGNO":5, "LUGLIO":6, "AGOSTO":7, "SETTEMBRE":8, "OTTOBRE":9, "NOVEMBRE":10, "DICEMBRE":11 };
        
        const HOLIDAYS = {
            "0-1": "CAPODANNO", "0-6": "EPIFANIA", "1-5": "S. AGATA",
            "2-25": "ARENGO", "3-1": "REGGENZA", "3-5": "PASQUA",
            "3-6": "LUN. ANGELO", "4-1": "1° MAGGIO", "5-4": "CORPUS DOM.",
            "6-28": "LIBERAZIONE", "7-15": "FERRAGOSTO", "8-3": "S. MARINO",
            "9-1": "REGGENZA", "10-1": "OGNISSANTI", "10-2": "COMM. DEFUNTI",
            "11-8": "IMMACOLATA", "11-25": "NATALE", "11-26": "S. STEFANO"
        };

        const SCHEDULE = {
            "M": "6:30-13:15", "MAT": "6:30-13:15", "MATTINA": "6:30-13:15",
            "P": "12:45-20:10", "POM": "12:45-20:10", "POMERIGGIO": "12:45-20:10",
            "N": "19:45-00:00", "NOTT": "19:45-00:00", "NOTTE": "19:45-00:00",
            "SM": "00:00-7:20", "SMONTO": "00:00-7:20", "S": "00:00-7:20", 
            "R": "RIPOSO", "RIP": "RIPOSO"
        };

        let finalData = [];
        let drivers = [];
        let currentDriverFilter = "all";

        function toggleMenu() {
            let m = document.getElementById('menu-dropdown');
            if(m.style.display === 'flex') {
                m.classList.remove('open');
                setTimeout(() => m.style.display = 'none', 100);
            } else {
                m.style.display = 'flex';
                setTimeout(() => m.classList.add('open'), 10);
            }
        }

        // Chiudi menu se clicchi fuori
        document.addEventListener('click', function(event) {
            let m = document.getElementById('menu-dropdown');
            let btn = document.querySelector('.btn-action[onclick="toggleMenu()"]');
            if (m.style.display === 'flex' && !m.contains(event.target) && !btn.contains(event.target)) {
                toggleMenu();
            }
        });

        // Register Service Worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('SW registrato', reg))
            .catch(err => console.log('SW fallito', err));
        }

        function toggleView() {
            const body = document.body;
            const btn = document.getElementById('view-btn');
            body.classList.toggle('desktop-view');
            if (body.classList.contains('desktop-view')) {
                btn.innerHTML = '<span class="material-icons-round">smartphone</span> MOBILE';
                btn.style.backgroundColor = "#e2e8f0";
            } else {
                btn.innerHTML = '<span class="material-icons-round">desktop_windows</span> PC';
                btn.style.backgroundColor = "#eff6ff";
            }
        }

        window.onload = async () => {
            try {
                const response = await fetch(FILE_NAME);
                if (!response.ok) throw new Error("File mancante");
                const buffer = await response.arrayBuffer();
                loadWorkbook(buffer);
            } catch (e) {
                document.getElementById('auto-loader').style.display = 'none';
                document.getElementById('manual-upload').style.display = 'block';
            }
        };

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => loadWorkbook(evt.target.result);
            reader.readAsArrayBuffer(file);
        });

        async function loadWorkbook(buffer) {
            const workbook = new ExcelJS.Workbook();
            await workbook.xlsx.load(buffer);
            let ws = workbook.getWorksheet("Foglio2") || workbook.worksheets[0];
            
            let rawData = [];
            ws.eachRow({ includeEmpty: true }, (row, rowNumber) => {
                let rowData = [];
                row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                    let val = cell.value;
                    if(typeof val === 'object' && val !== null) val = val.result || "";
                    let bg = null;
                    if(cell.fill && cell.fill.fgColor) {
                        bg = cell.fill.fgColor.argb;
                        if(!bg && cell.fill.fgColor.theme !== undefined) bg = "THEME_" + cell.fill.fgColor.theme; 
                    }
                    rowData[colNumber] = { v: val, c: bg };
                });
                rawData[rowNumber] = rowData;
            });

            finalData = convertHorizontalToVertical(rawData);
            document.getElementById('loader').style.display = 'none';
            initApp();
        }

        function convertHorizontalToVertical(raw) {
            let processed = [];
            let header = ["MESE", "GIORNO", "NOME"];
            let driverRows = [];
            
            for(let r=3; r<raw.length; r++) {
                if(!raw[r]) continue;
                let cellName = raw[r][1]; 
                
                // --- FIX 2: Lista nera basata sulle tue foto ---
                if(cellName && cellName.v && typeof cellName.v === 'string') {
                    let txt = cellName.v.toUpperCase();
                    // Blocca se contiene queste parole della legenda
                    if(txt.includes("CONGEDO") || txt.includes("MALATTIA") || txt.includes("RESIDUE") || 
                       txt.includes("P.S.") || txt.includes("RECUPERO") || txt.includes("PERM.") || 
                       txt.includes("ASPETTATIVA") || txt.includes("FEST.") || txt.includes("DISTACCO") || 
                       txt.includes("1>7") || txt.includes("P/PN")) {
                        continue; // SALTA LEGENDA
                    }
                }
                // ------------------------------------------------

                if(cellName && cellName.v && typeof cellName.v === 'string' && cellName.v.length > 2) {
                    let driverObj = { name: cellName.v, idx: r, subIdx: null };
                    if(raw[r+1] && (!raw[r+1][1] || !raw[r+1][1].v || raw[r+1][1].v.toString().trim() === "")) {
                        driverObj.subIdx = r + 1; 
                    }
                    driverRows.push(driverObj);
                    header.push(cellName.v);
                }
            }
            processed.push(header);

            let rowMese = raw[1];
            let rowGiorno = raw[2];
            let currentMonth = "";

            if(rowGiorno) {
                for(let c=2; c<rowGiorno.length; c++) {
                    let cellDay = rowGiorno[c];
                    let cellMese = rowMese ? rowMese[c] : null;
                    let dayNum = cellDay ? cellDay.v : null;
                    
                    if(cellMese && cellMese.v && typeof cellMese.v === 'string') {
                        let parts = cellMese.v.split("."); 
                        if(parts[0]) currentMonth = parts[0].trim().toUpperCase();
                    }

                    if(dayNum && !isNaN(parseInt(dayNum))) {
                        let newRow = [{v:currentMonth}, {v:dayNum}, {v:""}];
                        driverRows.forEach(dr => {
                            let mainData = raw[dr.idx][c] || {v:"", c:null};
                            let subData = dr.subIdx ? (raw[dr.subIdx][c] || {v:"", c:null}) : {v:"", c:null};
                            newRow.push({ v: mainData.v, c: mainData.c, subV: subData.v, subC: subData.c });
                        });
                        processed.push(newRow);
                    }
                }
            }
            return processed;
        }

        function initApp() {
            let header = finalData[0];
            drivers = [];
            for(let i=3; i<header.length; i++) {
                let name = header[i].toUpperCase();
                drivers.push({name: name, idx: i});
            }
            const drvNav = document.getElementById('driver-nav');
            drvNav.innerHTML = "";
            let btnAll = document.createElement('div');
            btnAll.className = "chip chip-driver active";
            btnAll.innerText = "TUTTI";
            btnAll.dataset.idx = "all";
            btnAll.onclick = () => filterDriver("all", btnAll);
            drvNav.appendChild(btnAll);

            drivers.forEach(d => {
                let btn = document.createElement('div');
                btn.className = "chip chip-driver";
                btn.innerText = d.name;
                btn.dataset.idx = d.idx;
                btn.onclick = () => filterDriver(d.idx, btn);
                drvNav.appendChild(btn);
            });

            let savedDr = localStorage.getItem("last_driver_view_v2");
            if(savedDr) {
                currentDriverFilter = savedDr;
                updateDriverButtons(savedDr);
            }
            renderTable();
            startLiveClock(); // AVVIA OROLOGIO
            
            // AUTO SCROLL A OGGI
            setTimeout(scrollToToday, 500);
        }

        function scrollToToday() {
            const el = document.getElementById('today-row');
            if (el) {
                const headerHeight = document.body.classList.contains('desktop-view') ? 130 : 160;
                const extraOffset = 100; 
                
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                
                const offsetPosition = elementPosition - headerHeight - extraOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        }

        function filterDriver(val, btnEl) {
            currentDriverFilter = val;
            localStorage.setItem("last_driver_view_v2", val);
            document.querySelectorAll('.chip-driver').forEach(b => b.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');
            renderTable();
        }

        function updateDriverButtons(val) {
             document.querySelectorAll('.chip-driver').forEach(b => {
                 b.classList.remove('active');
                 if(b.dataset.idx == val) b.classList.add('active');
             });
        }

        function startLiveClock() {
            // Aggiorna ogni secondo
            setInterval(() => {
                const now = new Date();
                const dateStr = now.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
                // --- MODIFICA 1: Aggiunti i secondi ---
                const timeStr = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const fullStr = `${dateStr} - ${timeStr}`;
                
                document.querySelectorAll('.live-clock').forEach(el => {
                    el.innerText = fullStr;
                });
            }, 1000);
        }

        function renderTable() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            const nav = document.getElementById('month-nav');
            thead.innerHTML = ""; tbody.innerHTML = ""; nav.innerHTML = "";

            let cols = (currentDriverFilter === "all") ? drivers : drivers.filter(d => d.idx == parseInt(currentDriverFilter));

            let thD = document.createElement('th'); thD.innerText = "DATA"; 
            thD.style.left = "0"; thD.style.zIndex="95"; thead.appendChild(thD);

            cols.forEach(d => {
                let th = document.createElement('th'); th.innerText = d.name; thead.appendChild(th);
            });

            let currentMonth = "";
            let monthsFound = [];
            let year = 2026;
            const today = new Date();
            const curD = today.getDate(); const curM = today.getMonth();

            for(let i = 1; i < finalData.length; i++) {
                let row = finalData[i];
                let mName = row[0].v;
                let dNum = parseInt(row[1].v);

                if(mName && mName !== currentMonth) {
                    currentMonth = mName;
                    let mId = "m-" + i;
                    monthsFound.push({name: mName, id: mId});
                    let trM = document.createElement('tr'); trM.className = "month-header";
                    trM.id = mId;
                    
                    // --- MODIFICA 2: Layout Mese/Ora a Sinistra e Vicini ---
                    trM.innerHTML = `
                    <td colspan="${cols.length + 1}">
                        <div class="sticky-month-text">
                            <span>${mName} ${year}</span>
                            <span class="live-clock" style="font-size:0.9rem; font-weight:600; opacity:0.9;"></span>
                        </div>
                    </td>`;
                    tbody.appendChild(trM);
                }

                let tr = document.createElement('tr');
                let mIdx = MONTH_MAP[currentMonth];
                
                // DATA
                let dateObj = new Date(year, mIdx, dNum);
                let dayWeek = dateObj.toLocaleDateString('it-IT', { weekday: 'short' }).toUpperCase();
                let dayIdx = dateObj.getDay(); 
                let holKey = `${mIdx}-${dNum}`;
                let holidayName = HOLIDAYS[holKey];
                
                let isRed = (dayIdx === 0 || dayIdx === 6 || holidayName);
                let dateClass = isRed ? "td-date date-red" : "td-date";
                
                if(mIdx === curM && dNum === curD && today.getFullYear() === year) {
                    tr.className = "today";
                    tr.id = "today-row"; // ID PER SCROLL AUTOMATICO
                }

                let dateHtml = `
                    ${dNum}
                    <small>${dayWeek}</small>
                    ${holidayName ? `<div class="holiday-name">${holidayName}</div>` : ""}
                `;
                
                tr.innerHTML = `<td class="${dateClass}">${dateHtml}</td>`;

                cols.forEach(d => {
                    let cellInfo = row[d.idx];
                    let td = document.createElement('td');
                    td.innerHTML = formatCell(cellInfo);
                    
                    let rawVal = cellInfo.v ? cellInfo.v.toString().trim() : "";
                    let shiftType = normalizeShift(rawVal);
                    if(["M", "P", "N", "R"].includes(shiftType)) {
                        td.onclick = () => openShiftModal(i, shiftType, mName, dNum, dayWeek);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }

            monthsFound.forEach(m => {
                let btn = document.createElement('div');
                btn.className = "chip chip-month";
                btn.innerText = m.name.substr(0,3);
                btn.onclick = () => {
                    document.querySelectorAll('.chip-month').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const el = document.getElementById(m.id);
                    const headerHeight = document.body.classList.contains('desktop-view') ? 130 : 160;
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = el.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offset = elementPosition - headerHeight;
                    window.scrollTo({ top: offset, behavior: "smooth" });
                };
                nav.appendChild(btn);
            });
        }

        function normalizeShift(val) {
            let u = val.toUpperCase();
            if(u === "M" || u.startsWith("MAT") || u === "M/R") return "M";
            if(u === "P" || u.startsWith("POM")) return "P";
            if(u === "N" || u.startsWith("NOT")) return "N";
            if(u === "R" || u.startsWith("RIP")) return "R";
            return "";
        }

        function openShiftModal(rowIndex, shiftType, month, day, weekDay) {
            let row = finalData[rowIndex];
            let list = document.getElementById('modal-list');
            let title = document.getElementById('modal-title');
            let sub = document.getElementById('modal-subtitle');
            let modalContent = document.querySelector('#shift-modal .modal-content');
            
            modalContent.classList.remove('modal-theme-M', 'modal-theme-P', 'modal-theme-N', 'modal-theme-R');
            modalContent.classList.add('modal-theme-' + shiftType);
            list.innerHTML = "";
            
            let fullShiftName = "";
            let iconHtml = "";
            if(shiftType === "M") { fullShiftName = "MATTINA"; iconHtml = '<span class="material-icons-round">wb_sunny</span>'; }
            if(shiftType === "P") { fullShiftName = "POMERIGGIO"; iconHtml = '<span class="material-icons-round">wb_twilight</span>'; }
            if(shiftType === "N") { fullShiftName = "NOTTE"; iconHtml = '<span class="material-icons-round">bedtime</span>'; }
            if(shiftType === "R") { fullShiftName = "RIPOSO"; iconHtml = '<span class="material-icons-round">weekend</span>'; }

            title.innerHTML = `${iconHtml} ${fullShiftName}`;
            sub.innerText = `${weekDay} ${day} ${month}`;
            
            let found = 0;
            drivers.forEach(d => {
                let cellData = row[d.idx];
                let val = cellData.v ? cellData.v.toString().trim() : "";
                
                if(normalizeShift(val) === shiftType) {
                    found++;
                    let time = "";
                    
                    if(val === "m" || val.startsWith('m')) time = "6:30-13:42";
                    else if(val === "p" || val.startsWith('p')) time = "13:15-20:27"; 

                    else if(val === "M/R") time = "6:30-13:15";
                    else time = SCHEDULE[val] || SCHEDULE[val.toUpperCase()] || SCHEDULE[val.charAt(0).toUpperCase()] || "";

                    if(shiftType === "R") time = "Riposo"; 
                    
                    let isRep = (val.toLowerCase().includes("/r") || val === "M/R");
                    let repTag = isRep ? `<span class="c-rep">REP</span>` : "";

                    let div = document.createElement('div');
                    div.className = "colleague-item";
                    div.innerHTML = `<span class="c-name">${d.name} ${repTag}</span><span class="c-time">${time}</span>`;
                    list.appendChild(div);
                }
            });
            
            if(found === 0) list.innerHTML = "<p style='text-align:center; color:#94a3b8; padding:20px'>Nessun altro collega trovato.</p>";
            let modal = document.getElementById('shift-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
        }

        function closeShiftModal(e) {
            if (e && e.target !== e.currentTarget) return; 
            let modal = document.getElementById('shift-modal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 200);
        }

        /* --- LOGICA MODALE CENA/EVENTO --- */
        let dinnerSelectedMonth = "";
        let eventType = "cena"; // 'cena' o 'pranzo'
        
        function openDinnerModal() {
            toggleMenu(); // Chiudi menu
            let modal = document.getElementById('dinner-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
            
            resetDinnerStep();

            // Popola Mesi
            let mList = document.getElementById('dinner-month-list');
            mList.innerHTML = "";
            let months = Object.keys(MONTH_MAP);
            months.forEach(m => {
                let c = document.createElement('div');
                c.className = "chip chip-month";
                c.innerText = m.substr(0,3);
                c.onclick = () => {
                    document.querySelectorAll('#dinner-month-list .chip-month').forEach(x => x.classList.remove('active'));
                    c.classList.add('active');
                    dinnerSelectedMonth = m;
                };
                mList.appendChild(c);
            });
            // Seleziona mese corrente di default
            if(!dinnerSelectedMonth) {
                let curMName = months[new Date().getMonth()];
                // Simulo click
                let chips = mList.getElementsByClassName('chip-month');
                if(chips[new Date().getMonth()]) chips[new Date().getMonth()].click();
            }

            // Popola Drivers (solo se vuoto)
            let dList = document.getElementById('dinner-driver-list');
            if(dList.children.length === 0) { 
                drivers.forEach(d => {
                    let item = document.createElement('label');
                    item.className = "dinner-check-item checked"; // Tutti selezionati di default
                    item.innerHTML = `
                        <input type="checkbox" value="${d.idx}" checked onchange="this.parentElement.classList.toggle('checked')">
                        <div class="dinner-check-icon"><span class="material-icons-round" style="font-size:14px">check</span></div>
                        ${d.name}
                    `;
                    dList.appendChild(item);
                });
            }
        }

        function setEventType(type, el) {
            eventType = type;
            document.querySelectorAll('.event-option').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        function toggleAllDrivers() {
            let checks = document.querySelectorAll('#dinner-driver-list input[type="checkbox"]');
            let allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => {
                c.checked = !allChecked;
                if(!allChecked) c.parentElement.classList.add('checked');
                else c.parentElement.classList.remove('checked');
            });
        }

        function closeDinnerModal(e) {
            if (e && e.target !== e.currentTarget) return;
            let modal = document.getElementById('dinner-modal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 200);
        }
        
        function resetDinnerStep() {
            document.getElementById('dinner-step-1').style.display = 'block';
            document.getElementById('dinner-step-2').style.display = 'none';
        }

        function calculateDinner() {
            if(!dinnerSelectedMonth) { alert("Seleziona un mese!"); return; }
            
            // Ottieni autisti selezionati
            let selectedDriversIdx = [];
            document.querySelectorAll('#dinner-driver-list input:checked').forEach(c => {
                selectedDriversIdx.push(parseInt(c.value));
            });
            
            if(selectedDriversIdx.length === 0) { alert("Seleziona almeno un collega!"); return; }

            let results = [];
            
            // Scansiona i giorni del mese selezionato
            for(let i=1; i<finalData.length; i++) {
                let row = finalData[i];
                if(row[0].v !== dinnerSelectedMonth) continue;
                
                let dayNum = row[1].v;
                let mIdx = MONTH_MAP[dinnerSelectedMonth];
                let dateObj = new Date(2026, mIdx, dayNum);
                let dayWeek = dateObj.toLocaleDateString('it-IT', { weekday: 'long' });
                
                let availableCount = 0;
                let missingNames = [];
                let reperibiliNames = [];
                
                selectedDriversIdx.forEach(dIdx => {
                    let cellData = row[dIdx];
                    let val = cellData.v ? cellData.v.toString().trim().toUpperCase() : "";
                    
                    let isBusy = false;
                    let isRep = (val.toLowerCase().includes("/r") || row[dIdx].subV === "R");

                    // CHECK MALATTIA/FERIE/ETC SEMPRE ESCLUSI
                    if(val === "MALATTIA" || val === "MAL" || val === "M" || val === "ASP" || val.includes("CONG") || val === "F") {
                        isBusy = true;
                    } 
                    else if(eventType === 'cena') {
                        // CENA: Conflitto ESCLUSIVO con NOTTE (N)
                        if(val.startsWith("N") || val === "NOT") isBusy = true;
                    } else {
                        // PRANZO: Conflitto ESCLUSIVO con POMERIGGIO (P)
                        if(val.startsWith("P") || val === "POM") isBusy = true;
                    }

                    if(isBusy) {
                        let dName = drivers.find(d => d.idx === dIdx).name;
                        missingNames.push(dName);
                    } else {
                        availableCount++;
                        if(isRep) {
                            let dName = drivers.find(d => d.idx === dIdx).name;
                            reperibiliNames.push(dName);
                        }
                    }
                });
                
                results.push({
                    day: dayNum,
                    weekDay: dayWeek,
                    score: availableCount,
                    total: selectedDriversIdx.length,
                    missing: missingNames,
                    reperibili: reperibiliNames
                });
            }
            
            // Ordina: prima per punteggio (desc), poi preferenza Venerdì/Sabato
            results.sort((a, b) => {
                if(b.score !== a.score) return b.score - a.score;
                // Se pari merito, preferisci Ven/Sab
                let isWeA = (a.weekDay === "venerdì" || a.weekDay === "sabato");
                let isWeB = (b.weekDay === "venerdì" || b.weekDay === "sabato");
                if(isWeA && !isWeB) return -1;
                if(!isWeA && isWeB) return 1;
                return 0;
            });
            
            // Mostra Risultati
            let resContainer = document.getElementById('dinner-results-container');
            let eventName = (eventType === 'cena') ? "CENE" : "PRANZI";
            resContainer.innerHTML = `<h4 style="margin:0 20px 10px; color:#64748b">MIGLIORI DATE PER ${eventName} - ${dinnerSelectedMonth}</h4>`;
            
            // Prendi i primi 10
            results.slice(0, 10).forEach(res => {
                let div = document.createElement('div');
                div.className = "dinner-result-card";
                
                let missingHtml = res.missing.length > 0 
                    ? res.missing.map(n => `<span class="missing-badge">${n}</span>`).join("") 
                    : "";

                let repHtml = res.reperibili.length > 0
                    ? res.reperibili.map(n => `<span class="warning-badge">👮‍♂️ ${n}</span>`).join("")
                    : "";
                
                let conflictLabel = (eventType === 'cena') ? "Turno N" : "Turno P";

                // --- LOGICA MODIFICATA: SE NESSUNO MANCA, È TUTTI LIBERI ---
                let allFreeHtml = "";
                if(res.missing.length === 0) {
                    allFreeHtml = `<div style="text-align:center; color:#15803d; font-size:0.9rem; font-weight:800; padding:5px; margin-top:5px;">TUTTI LIBERI! 🥂</div>`;
                }

                div.innerHTML = `
                    <div class="d-res-header">
                        <span class="d-res-date">${res.weekDay} ${res.day}</span>
                        <span class="d-res-score">${res.score} / ${res.total}</span>
                    </div>
                    
                    ${allFreeHtml}

                    ${repHtml ? `<div style="font-size:0.75rem; color:#c2410c; margin:8px 0 4px; font-weight:700;">IN SERVIZIO / REPERIBILI:</div>
                    <div class="missing-list" style="margin-bottom:10px;">${repHtml}</div>` : ""}

                    ${missingHtml ? `<div style="font-size:0.75rem; color:#94a3b8; margin-bottom:4px;">ASSENTI (${conflictLabel}):</div>
                    <div class="missing-list">${missingHtml}</div>` : ""}
                `;
                resContainer.appendChild(div);
            });
            
            document.getElementById('dinner-step-1').style.display = 'none';
            document.getElementById('dinner-step-2').style.display = 'block';
        }

        // --- GESTIONE STATISTICHE ---
        
        function openStatsSelection() {
            let container = document.getElementById('stats-container');
            container.innerHTML = "";
            let h3 = document.querySelector('.stats-header h3');
            h3.innerHTML = "SELEZIONA AUTISTA";
            h3.style.color = "#1e293b";

            drivers.forEach(d => {
                let div = document.createElement('div');
                div.className = "driver-list-item";
                div.innerHTML = `<span>${d.name}</span><span class="material-icons-round" style="color:#cbd5e1">chevron_right</span>`;
                div.onclick = () => showDriverStats(d);
                container.appendChild(div);
            });

            document.getElementById('stats-modal').classList.add('open');
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').classList.remove('open');
        }

        function showDriverStats(driver) {
            let container = document.getElementById('stats-container');
            let h3 = document.querySelector('.stats-header h3');
            h3.innerHTML = driver.name;
            h3.style.color = "var(--primary)";

            // Variabili conteggio
            let stats = {
                ferie: 0,
                congedo: 0,
                permessi: 0,
                recupero: 0,
                malattia: 0,
                festNonGod: 0,
                mattine: 0,
                pomeriggi: 0,
                notti: 0
            };

            // Loop su tutti i giorni
            for(let i=1; i<finalData.length; i++) {
                let row = finalData[i];
                let cellData = row[driver.idx];
                if(!cellData) continue;

                let val = cellData.v ? cellData.v.toString().trim() : "";
                let color = cellData.c || "";
                let subColor = cellData.subC || "";
                let subVal = cellData.subV ? cellData.subV.toString().trim().toUpperCase() : "";
                let u = val.toUpperCase();

                // Logica di classificazione (replica di formatCell)
                let matched = false;

                // --- MODIFICA 2: Gestione NL nelle Statistiche ---
                if(u === "NL" || subVal === "NL") { stats.festNonGod++; matched=true; }
                
                if(subVal === "NG") { stats.festNonGod++; matched=true; }
                if(subVal === "M") { stats.malattia++; matched=true; }
                if(matched) continue;

                // 1. Malattia o Festivo (Riga Sotto - Colori)
                if(subColor && subColor.length >= 6) {
                    let cat = detectColorCategory(subColor);
                    if(cat) {
                        if(cat.lbl === "MALATTIA") { stats.malattia++; matched=true; }
                        else if(cat.lbl.includes("FESTIVO")) { stats.festNonGod++; matched=true; }
                    }
                }

                if(matched) continue;

                // 2. Colori Cella Principale
                if(color && color.length >= 6) {
                    let cat = detectColorCategory(color);
                    if(cat) {
                        if(cat.lbl.includes("PERMESSO")) { stats.permessi++; matched=true; }
                        else if(cat.lbl.includes("CONGEDO")) { stats.congedo++; matched=true; }
                        else if(cat.lbl.includes("FERIE")) { stats.ferie++; matched=true; }
                        else if(cat.lbl.includes("RECUPERO")) { stats.recupero++; matched=true; }
                        else if(cat.lbl.includes("FESTIVO")) { stats.festNonGod++; matched=true; }
                    }
                }

                if(matched) continue;

                // 3. Testo
                if(u.includes("FER") || subVal.includes("FER")) stats.ferie++;
                else if(u.includes("CONG") || subVal.includes("CONG")) stats.congedo++;
                else if(u.includes("REC") || subVal.includes("REC") || subVal === "R") stats.recupero++; // Added R here too
                else if(u.includes("PER") || subVal.includes("PER")) stats.permessi++;
                
                // 4. Turni
                else if(u.startsWith("M") || val === "m") stats.mattine++;
                else if(u.startsWith("P") || val === "p") stats.pomeriggi++;
                else if(u.startsWith("N")) stats.notti++;
            }

            // Render Griglia
            container.innerHTML = `
                <div class="driver-list-item" onclick="openStatsSelection()" style="background:#f1f5f9; color:#64748b; margin-bottom:20px;">
                    <span style="display:flex; align-items:center; gap:10px;"><span class="material-icons-round">arrow_back</span> TORNA ALLA LISTA</span>
                </div>
                
                <h4 style="margin:0 0 10px 0; color:#64748b; font-size:0.8rem; text-transform:uppercase;">Assenze & Permessi</h4>
                <div class="stats-grid">
                    <div class="stat-card sc-fer">
                        <span class="stat-val">${stats.ferie}</span>
                        <span class="stat-lbl">Ferie Residue</span>
                    </div>
                    <div class="stat-card sc-cong">
                        <span class="stat-val">${stats.congedo}</span>
                        <span class="stat-lbl">Congedi Ord.</span>
                    </div>
                    <div class="stat-card sc-perm">
                        <span class="stat-val">${stats.permessi}</span>
                        <span class="stat-lbl">Permessi Str.</span>
                    </div>
                    <div class="stat-card sc-rec">
                        <span class="stat-val">${stats.recupero}</span>
                        <span class="stat-lbl">Recuperi</span>
                    </div>
                    <div class="stat-card sc-mal">
                        <span class="stat-val">${stats.malattia}</span>
                        <span class="stat-lbl">Malattia</span>
                    </div>
                    <div class="stat-card sc-fest">
                        <span class="stat-val">${stats.festNonGod}</span>
                        <span class="stat-lbl">Fest. Non God.</span>
                    </div>
                </div>

                <h4 style="margin:25px 0 10px 0; color:#64748b; font-size:0.8rem; text-transform:uppercase;">Turni Svolti</h4>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="stat-card" style="border-color:var(--b-M); background:var(--c-M); color:var(--t-M);">
                        <span class="stat-val">${stats.mattine}</span>
                        <span class="stat-lbl">Mattine</span>
                    </div>
                    <div class="stat-card" style="border-color:var(--b-P); background:var(--c-P); color:var(--t-P);">
                        <span class="stat-val">${stats.pomeriggi}</span>
                        <span class="stat-lbl">Pomeriggi</span>
                    </div>
                    <div class="stat-card" style="border-color:var(--b-N); background:var(--c-N); color:white;">
                        <span class="stat-val">${stats.notti}</span>
                        <span class="stat-lbl" style="color:#94a3b8">Notti</span>
                    </div>
                </div>
            `;
        }

        // --- RICONOSCIMENTO COLORI (PUNTEGGIO) ---
        function detectColorCategory(argb) {
            if(!argb || argb.length < 8) return null;
            let r = parseInt(argb.substring(2, 4), 16);
            let g = parseInt(argb.substring(4, 6), 16);
            let b = parseInt(argb.substring(6, 8), 16);

            // LOGICA DOMINANZA "FLESSIBILE"
            
            // 1. ROSSO (Malattia)
            if (r > g + 40 && r > b + 40) return { lbl: "MALATTIA", cls: "spec-red" };

            // 2. BLU/CIANO (Festivo non goduto)
            let blueDominant = (b > r + 40 && b > g + 40);
            let cyanDominant = (b > r + 40 && g > r + 40); 
            if (blueDominant || cyanDominant) return { lbl: "FESTIVO<br>NON GODUTO", cls: "spec-blue" };

            // 3. VERDE (Permesso)
            if (g > r && g > b) return { lbl: "PERMESSO<br>STRAORD.", cls: "spec-green" };
            
            // 4. GIALLO/ARANCIO (Congedo/Ferie)
            if (r > b && r > g) {
                if (g > 180 && g >= r * 0.8) return { lbl: "CONGEDO<br>ORDINARIO", cls: "spec-yellow" };
                if (g > 80 && g < r * 0.8) return { lbl: "FERIE<br>RESIDUE", cls: "spec-orange" };
            }
            
            // 5. VIOLA/ROSA (Recupero)
            if ((r > 150 && b > 100) || (r > g && b > g)) return { lbl: "RECUPERO", cls: "spec-pink" };
            
            return null; 
        }

        function formatCell(info) {
            let val = info.v ? info.v.toString().trim() : "";
            let color = info.c || "";
            let subColor = info.subC || ""; 
            let u = val.toUpperCase();
            let subVal = info.subV ? info.subV.toString().trim().toUpperCase() : "";

            // --- GESTIONE NL (FESTIVO NON LAVORATO) ---
            if(u === "NL" || subVal === "NL") return renderSpecial("FESTIVO<br>NON LAVORATO", "spec-nl");

            // --- GESTIONE ALTRI STATI SPECIALI ---
            if(subVal === "NG") return renderSpecial("FESTIVO<br>NON GODUTO", "spec-blue");
            if(subVal === "M") return renderSpecial("MALATTIA", "spec-red");
            
            // PRIORITÀ 1: Riga sotto (Festivo/Malattia da colore)
            if (subColor && !subColor.startsWith('FFFFFFFF') && subColor !== 'FF000000' && subColor.length >= 6) {
                let subCat = detectColorCategory(subColor);
                if (subCat && (subCat.cls === "spec-blue" || subCat.cls === "spec-red")) {
                    return `<div class="cell ${subCat.cls}">${subCat.lbl}</div>`;
                }
            }

            // PRIORITÀ 2: Cella principale colorata
            let hasColor = (color && !color.startsWith('FFFFFFFF') && color !== 'FF000000' && color.length >= 6); 
            if(hasColor) {
                let cat = detectColorCategory(color);
                if(cat) return `<div class="cell ${cat.cls}">${cat.lbl}</div>`;
            }

            let isEmpty = (val === "-" || val === "." || val === "0" || val === "");
            
            // --- GESTIONE TESTUALE (CONGEDI, FERIE, RECUPERI) ---
            if(subVal === "F" || subVal.includes("CONG")) return renderSpecial("CONGEDO<br>ORDINARIO", "spec-yellow");
            if(subVal === "V" || subVal.includes("FER")) return renderSpecial("FERIE<br>RESIDUE", "spec-orange");
            
            // *** CORREZIONE PER 'r' minuscola e maiuscola ***
            if(subVal === "R" || subVal.includes("REC")) return renderSpecial("RECUPERO", "spec-pink");
            
            if(subVal === "P" || subVal.includes("PER")) return renderSpecial("PERMESSO<br>STRAORD.", "spec-green");
            
            // Check cella principale
            if(u === "F" || u.includes("CONG")) return `<div class="cell spec-yellow">CONGEDO<br>ORDINARIO</div>`;
            if(u === "V" || u.includes("FER")) return `<div class="cell spec-orange">FERIE<br>RESIDUE</div>`;
            if(u.includes("REC")) return `<div class="cell spec-pink">RECUPERO</div>`;
            if(u.includes("PERM")) return `<div class="cell spec-green">PERMESSO<br>STRAORD.</div>`;
            
            if(isEmpty) return `<div class="cell empty">-</div>`;

            let display = u;
            let cls = "cell";
            let time = "";

            /* --- LOGICA DI ASSEGNAZIONE CLASSI --- */
            
            let rawVal = val.trim();
            let firstChar = rawVal.charAt(0);

            // 1. DIURNISTA (m/p minuscoli)
            if (firstChar === 'm' || firstChar === 'p') {
                if (firstChar === 'm') {
                      display = "MATTINA";
                      time = "6:30-13:42";
                } else {
                      display = "POMERIGGIO";
                      time = "13:15-20:27";
                }
                cls += " t-diurno"; 
            }
            // 2. TURNISTA (M/P/N maiuscoli)
            else {
                if(u.startsWith("M")) { display = "MATTINA"; cls += " t-M"; }
                else if(u.startsWith("P")) { display = "POMERIGGIO"; cls += " t-P"; }
                else if(u.startsWith("N")) { display = "NOTTE"; cls += " t-N"; }
                else if(u.startsWith("R")) { display = "RIPOSO"; cls += " t-R"; }
                else if(u.startsWith("S")) { display = "SMONTO"; cls += " t-SM"; }
                else { cls += " empty"; }

                if (!time) {
                    if (SCHEDULE[val]) { time = SCHEDULE[val]; }
                    else if(SCHEDULE[u]) { time = SCHEDULE[u]; }
                    else if(SCHEDULE[val.charAt(0)]) { time = SCHEDULE[val.charAt(0)]; }
                }
            }

            // REPERIBILITÀ
            let isRep = false;
            if (rawVal.toLowerCase().includes("/r")) isRep = true; 
            
            let repHtml = isRep ? `<div class="rep-badge">REPERIBILE</div>` : "";

            return `<div class="${cls}">
                <div>${display}</div>
                ${time ? `<div class="time-tag">${time}</div>` : ""}
                ${repHtml}
            </div>`;
        }

        function renderSpecial(text, cssClass) {
            return `<div class="cell ${cssClass}">${text}</div>`;
        }
    </script>
</body>
</html>