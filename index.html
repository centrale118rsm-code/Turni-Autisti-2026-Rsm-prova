<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ffffff" id="theme-color-meta">
    <meta name="apple-mobile-web-app-title" content="Turni 2026">
    <meta name="description" content="Gestione Turni Autisti 2026 - San Marino">
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="logo.png">
    <link rel="icon" type="image/png" href="logo.png">
    
    <title>TURNI AUTISTI 2026</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- RESET E BASE --- */
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; outline: none; }
        
        :root {
            --primary: #2563eb; 
            --bg: #f8fafc;
            --bg-card: #ffffff;
            --text-main: #0f172a;
            --text-sec: #64748b;
            --border: #e2e8f0;
            --header-bg: rgba(255, 255, 255, 0.92);
            
            --header-h: 155px;        
            --cell-h: 82px;             
            --font-base: 0.95rem;        
            --font-small: 0.75rem;       
            --th-h: 44px;                
            
            /* --- COLORI TURNI (Base) --- */
            --c-M: #026bfe; --t-M: #ffffff; --b-M: #bae6fd;
            --c-P: #56a2ff; --t-P: #ffffff; --b-P: #c7d2fe;
            --c-N: #003785; --t-N: #ffffff; --b-N: #c7d2fe;
            --c-D-day: #fff1f2; --t-D-day: #4b5563; --b-D-day: #cc506983;
            --c-R: #ecfdf5; --t-R: #059669; --b-R: #6ee7b7;
            --c-SM: #10004f; --t-SM: #ffffff; --b-SM: #cbd5e1;

            /* Specifici */
            --bg-ferie: #ff782ff6; --t-ferie: #ffffff; --b-ferie: #a15300;
            --bg-perm: #00e749; --t-perm: #000000; --b-perm: #004e1c;
            --bg-cong: #ffea00; --t-cong: #000000; --b-cong: #fbff00;
            --bg-rec: #d00173; --t-rec: #ffe8f2; --b-rec: #c3006b;
            
            --bg-fest: #f0f9ff; --t-fest: #0284c7; --b-fest: #7dd3fc;
            --bg-mal: #8c8b8b; --t-mal: #bcbcbc; --b-mal: #f70000;

            --month-bar-bg: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            --shadow-soft: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* --- DARK MODE VARIABLES --- */
        body.dark-mode {
            --bg: #0f172a; /* Slate 900 */
            --bg-card: #1e293b; /* Slate 800 */
            --text-main: #f1f5f9; /* Slate 100 */
            --text-sec: #94a3b8; /* Slate 400 */
            --border: #334155; /* Slate 700 */
            --header-bg: rgba(15, 23, 42, 0.95);
            --theme-color: #0f172a;
        }

        body.desktop-view {
            --header-h: 120px;
            --cell-h: 60px;
            --font-base: 0.9rem;
            --font-small: 0.75rem;
            --th-h: 35px;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: var(--bg); margin: 0; padding-top: var(--header-h); 
            color: var(--text-main); transition: background 0.3s ease, color 0.3s ease; 
            overscroll-behavior-y: none; 
        }

        /* HEADER */
        header {
            position: fixed; top: 0; left: 0; right: 0;
            background: var(--header-bg); 
            box-shadow: 0 1px 0 rgba(0,0,0,0.08);
            z-index: 1000; height: var(--header-h);
            display: flex; flex-direction: column;
            padding-top: env(safe-area-inset-top);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .top-bar { padding: 0 16px; display: flex; justify-content: space-between; align-items: center; height: 55px; flex-shrink: 0; }
        .logo { font-size: 1.25rem; font-weight: 900; color: var(--text-main); display: flex; align-items: center; gap: 10px; letter-spacing: -0.5px; }
        .logo img { filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); border-radius: 8px; }
        
        .right-controls { display: flex; gap: 8px; position: relative; }

        .btn-action { 
            background: var(--bg-card); color: var(--text-sec); border: 1px solid var(--border); padding: 8px 12px; 
            border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 0.75rem; 
            display: flex; align-items: center; gap: 6px; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .btn-action:active { transform: scale(0.94); opacity: 0.8; }
        
        /* MENU DROPDOWN */
        #menu-dropdown { 
            position: absolute; top: 55px; right: 8px; background: var(--bg-card); 
            border-radius: 16px; box-shadow: 0 10px 30px -10px rgba(0,0,0,0.2); 
            width: 220px; overflow: hidden; display: none; border: 1px solid var(--border); 
            flex-direction: column; z-index: 5000; transform-origin: top right;
        }
        #menu-dropdown.open { display: flex; animation: scaleIn 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .menu-item { padding: 16px 20px; display: flex; align-items: center; gap: 12px; font-weight: 600; color: var(--text-main); border-bottom: 1px solid var(--border); cursor: pointer; transition: 0.2s; }
        .menu-item:last-child { border-bottom: none; }
        .menu-item:active { background: var(--bg); }
        .menu-item span { color: var(--primary); }
        
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }

        /* SCROLLERS */
        .nav-scroller, .driver-scroller { flex: 1; display: flex; gap: 8px; overflow-x: auto; padding: 0 16px; align-items: center; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .nav-scroller { border-bottom: 1px solid var(--border); }
        
        .chip { 
            padding: 8px 16px; border-radius: 10px; font-size: 0.8rem; font-weight: 700; 
            white-space: nowrap; cursor: pointer; transition: all 0.2s ease; 
            display: flex; align-items: center; justify-content: center;
        }
        
        .chip-month { background: var(--bg-card); color: var(--text-sec); border: 1px solid var(--border); }
        .chip-month.active { background: var(--primary); color: white; border-color: var(--primary); box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3); transform: translateY(-1px); }
        
        .chip-driver { background: var(--bg); color: var(--text-sec); border: 1px solid var(--border); }
        .chip-driver.active { background: var(--text-main); color: var(--bg-card); border-color: var(--text-main); box-shadow: 0 4px 10px rgba(0,0,0,0.1); transform: translateY(-1px); }

        /* TABLE */
        .container { padding: 0; max-width: 100%; margin: 0 auto; padding-bottom: 80px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; }

        thead th {
            background: var(--bg); color: var(--text-sec); padding: 5px; font-size: 0.7rem; 
            text-transform: uppercase; font-weight: 800; letter-spacing: 0.5px;
            position: sticky; top: var(--header-h); z-index: 90; 
            border-bottom: 1px solid var(--border); text-align: center; min-width: 115px;
            height: var(--th-h); backdrop-filter: blur(5px);
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        thead th:first-child, .td-date { width: 60px !important; min-width: 60px !important; max-width: 60px !important; }

        /* --- STILE BARRA MESE (Premium) --- */
        tr.month-header td {
            background: var(--month-bar-bg);
            color: white; 
            position: sticky; top: calc(var(--header-h) + var(--th-h)); z-index: 85; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); 
            padding: 0; 
            border: none;
            line-height: 1;
        }
        .sticky-month-text { 
            position: sticky; left: 0; width: 100vw; 
            text-align: left; 
            padding: 4px 0 4px 16px; 
            display: flex; 
            align-items: center;
            gap: 12px;
            min-height: 40px;
        }
        .month-label {
            font-weight: 900;
            font-size: 1.4rem; 
            text-transform: uppercase;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .live-clock { 
            font-variant-numeric: tabular-nums; 
            font-weight: 800; 
            font-size: 1rem; 
            background: rgba(0,0,0,0.25); 
            padding: 2px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            letter-spacing: 0.5px;
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.1);
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        tbody td { 
            padding: 2px; height: var(--cell-h); vertical-align: middle; 
            border-bottom: 1px solid var(--border); border-right: 1px dashed var(--border); 
            transition: height 0.3s ease;
        }
        
        .td-date { 
            text-align: center; font-weight: 800; color: var(--text-main); font-size: 1.1rem; 
            border-right: 2px solid var(--border); background: var(--bg);
            position: sticky; left: 0; z-index: 80;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            height: var(--cell-h); 
        }
        .td-date small { display: block; font-weight: 600; font-size: 0.7rem; text-transform: uppercase; color: var(--text-sec); margin-top: 2px; }
        
        .td-date.date-red { color: #dc2626; background: #fef2f2; border-right-color: #fca5a5; }
        .td-date.date-red small { color: #ef4444; }
        /* Dark mode red overrides */
        body.dark-mode .td-date.date-red { background: #450a0a; color: #fca5a5; border-right-color: #7f1d1d; }
        body.dark-mode .td-date.date-red small { color: #fecaca; }

        .holiday-name { font-size: 0.55rem; color: #dc2626; font-weight: 900; line-height: 1; margin-top: 3px; max-width: 55px; white-space: normal; }
        body.dark-mode .holiday-name { color: #f87171; }

        .cell { 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            height: 100%; width: 100%; border-radius: 10px; font-weight: 800; 
            font-size: var(--font-base); text-transform: uppercase; position: relative; 
            line-height: 1.2; text-align: center; cursor: pointer;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); transition: transform 0.1s;
            /* FIX CRITICO: Spazio extra per badge */
            padding-bottom: 4px; 
        }
        .cell:active { transform: scale(0.96); }
        
        /* Dark Mode Cells Logic */
        body.dark-mode .cell.empty { color: #475569; }
        body.dark-mode .cell { box-shadow: none; border: 1px solid rgba(255,255,255,0.05); }

        .time-tag { font-size: var(--font-small); font-weight: 600; opacity: 0.85; margin-top: 1px; letter-spacing: -0.3px; }
        
        /* FIX BADGE REPERIBILITÀ - PIXEL PERFECT */
        .rep-badge { 
            font-size: 0.6rem; 
            color: #ffffff; 
            margin-top: 2px; /* Margine controllato */
            font-weight: 900; 
            background: linear-gradient(135deg, #ef4444, #dc2626); 
            padding: 2px 7px; /* Padding ridotto */
            border-radius: 5px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.2); 
            letter-spacing: 0.5px;
            line-height: 1; 
            white-space: nowrap;
        }

        .t-M { background: var(--c-M); color: var(--t-M); border: 1px solid var(--b-M); }
        .t-P { background: var(--c-P); color: var(--t-P); border: 1px solid var(--b-P); }
        .t-N { background: var(--c-N); color: var(--t-N); border: 1px solid var(--b-N); }
        .t-R { background: var(--c-R); color: var(--t-R); border: 1px solid var(--b-R); }
        .t-SM { background: var(--c-SM); color: var(--t-SM); border: 1px solid var(--b-SM); }
        
        /* Dark Mode Overrides for standard shifts */
        body.dark-mode .t-M { background: #1e40af; border-color: #1e3a8a; }
        body.dark-mode .t-P { background: #3b82f6; border-color: #2563eb; }
        body.dark-mode .t-N { background: #172554; border-color: #0f172a; }

        .t-diurno { background: var(--c-D-day) !important; color: var(--t-D-day) !important; border: 1px solid var(--b-D-day) !important; }
        body.dark-mode .t-diurno { background: #334155 !important; color: #e2e8f0 !important; border-color: #475569 !important; }

        .spec-orange { background: var(--bg-ferie); color: var(--t-ferie); border: 1px solid var(--b-ferie); font-size: 0.7rem; }
        .spec-green { background: var(--bg-perm); color: var(--t-perm); border: 1px solid var(--b-perm); font-size: 0.7rem; }
        .spec-yellow { background: var(--bg-cong); color: var(--t-cong); border: 1px solid var(--b-cong); font-size: 0.7rem; }
        .spec-pink { background: var(--bg-rec); color: var(--t-rec); border: 1px solid var(--b-rec); font-size: 0.7rem; }
        
        .spec-blue { background: #e0f2fe !important; color: #0369a1 !important; border: 1px solid #7dd3fc !important; font-size: 0.7rem; }
        .spec-red { background: #fee2e2 !important; color: #b91c1c !important; border: 1px solid #fca5a5 !important; font-size: 0.8rem; }
        .spec-nl { background: #e0f7fa !important; color: #006064 !important; border: 1px solid #b2ebf2 !important; font-size: 0.7rem; }
        
        .empty { background: transparent; box-shadow: none; color: #cbd5e1; font-weight: 400;}

        tr.today td { background: #fff7ed !important; border-bottom: 2px solid #f97316 !important; }
        tr.today .td-date { color: #ea580c; border-left: 6px solid #ea580c; background: #fff7ed; border-right: 2px solid #f97316; }
        
        /* Dark Mode Today Row */
        body.dark-mode tr.today td { background: #431407 !important; border-bottom: 2px solid #ea580c !important; }
        body.dark-mode tr.today .td-date { background: #431407; color: #fdba74; }

        /* LOADER */
        #loader { position: fixed; inset: 0; background: var(--bg); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; padding: 20px;}
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #manual-upload { display: none; margin-top: 20px; animation: fadeIn 0.5s ease; }
        .file-label { background: var(--primary); color: white; padding: 12px 24px; border-radius: 12px; font-weight: bold; cursor: pointer; font-size: 0.95rem; display: inline-flex; align-items: center; gap: 8px; margin-top: 15px; box-shadow: 0 4px 15px rgba(37,99,235,0.4); transition: transform 0.2s; }
        .file-label:active { transform: scale(0.96); }
        input[type="file"] { display: none; }
        
        body.desktop-view .driver-scroller { display: none; }

        /* MODALE */
        #shift-modal, #dinner-modal { display: none; position: fixed; inset: 0; background: rgba(0, 0, 0, 0.6); z-index: 3000; backdrop-filter: blur(8px); align-items: flex-end; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        #shift-modal.open, #dinner-modal.open { opacity: 1; }
        .modal-content { background: var(--bg-card); width: 100%; max-width: 600px; border-radius: 24px 24px 0 0; box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.3); overflow: hidden; transform: translateY(100%); transition: transform 0.35s cubic-bezier(0.16, 1, 0.3, 1); max-height: 85vh; display: flex; flex-direction: column; }
        #shift-modal.open .modal-content, #dinner-modal.open .modal-content { transform: translateY(0); }
        
        .modal-header { background: var(--bg); color: var(--text-main); padding: 20px 24px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
        .header-text h3 { margin: 0; font-size: 1.3rem; font-weight: 800; color: var(--text-main); display: flex; align-items: center; gap: 10px;}
        .header-text span { display: block; font-size: 0.9rem; font-weight: 600; color: var(--text-sec); margin-top: 4px;}
        
        .btn-close-modal { background: var(--bg); border: none; color: var(--text-sec); cursor: pointer; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        
        .modal-body { padding: 0; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .colleague-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; border-bottom: 1px solid var(--border); transition: background 0.2s; }
        .c-name { font-weight: 700; color: var(--text-main); font-size: 1rem; }
        .c-time { font-size: 0.8rem; font-weight: 600; color: var(--text-sec); background: var(--bg); padding: 6px 12px; border-radius: 8px; font-variant-numeric: tabular-nums; }
        
        /* Modal Themes keep colors */
        .modal-theme-M .modal-header { background: linear-gradient(135deg, #e0f2fe 0%, #f0f9ff 100%); } .modal-theme-M .header-text h3 { color: #0c4a6e; } .modal-theme-M .c-time { background: #e0f2fe; color: #0369a1; }
        .modal-theme-P .modal-header { background: linear-gradient(135deg, #e0e7ff 0%, #eef2ff 100%); } .modal-theme-P .header-text h3 { color: #312e81; } .modal-theme-P .c-time { background: #e0e7ff; color: #4338ca; }
        .modal-theme-N .modal-header { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); } .modal-theme-N .header-text h3 { color: white; } .modal-theme-N .header-text span { color: #94a3b8; } .modal-theme-N .btn-close-modal { background: #334155; color: white; } .modal-theme-N .c-time { background: #f1f5f9; color: #0f172a; }
        .modal-theme-R .modal-header { background: linear-gradient(135deg, #dcfce7 0%, #ecfdf5 100%); } .modal-theme-R .header-text h3 { color: #064e3b; } .modal-theme-R .c-time { background: #dcfce7; color: #15803d; }

        /* MODALE CENA */
        .dinner-checkbox-list { padding: 16px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .dinner-check-item { background: var(--bg-card); padding: 12px; border-radius: 12px; border: 1px solid var(--border); display: flex; align-items: center; gap: 10px; cursor: pointer; font-size: 0.85rem; font-weight: 600; color: var(--text-sec); transition: all 0.2s; }
        .dinner-check-item.checked { background: var(--bg); border-color: var(--primary); color: var(--primary); box-shadow: 0 2px 4px rgba(37,99,235,0.1); }
        .dinner-check-item input { display: none; }
        .dinner-check-icon { width: 22px; height: 22px; border-radius: 6px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .dinner-check-item.checked .dinner-check-icon { background: var(--primary); border-color: var(--primary); color: white; }
        
        .dinner-section-title { font-size: 0.75rem; font-weight: 800; color: var(--text-sec); padding: 20px 20px 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .month-selector { display: flex; overflow-x: auto; gap: 8px; padding: 0 20px 10px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        .btn-find-dinner { margin: 20px; background: #0f172a; color: white; border: none; padding: 16px; border-radius: 14px; font-weight: 800; font-size: 1rem; width: calc(100% - 40px); cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 12px rgba(15, 23, 42, 0.3); transition: 0.2s; }
        body.dark-mode .btn-find-dinner { background: var(--primary); }

        .event-type-selector { display: flex; background: var(--bg); padding: 4px; border-radius: 14px; margin: 0 20px 10px; }
        .event-option { flex: 1; text-align: center; padding: 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; color: var(--text-sec); cursor: pointer; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .event-option.active { background: var(--bg-card); color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.08); }

        .dinner-result-card { background: var(--bg-card); margin: 10px 20px; padding: 16px; border-radius: 16px; border: 1px solid var(--border); box-shadow: var(--shadow-soft); }
        .d-res-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 12px; margin-bottom: 12px; }
        .d-res-date { font-weight: 800; font-size: 1.1rem; color: var(--text-main); text-transform: capitalize; }
        .d-res-score { background: #dcfce7; color: #15803d; font-weight: 700; padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }
        body.dark-mode .d-res-score { background: #064e3b; color: #dcfce7; }
        .missing-list { display: flex; flex-wrap: wrap; gap: 6px; }
        .missing-badge { background: #fee2e2; color: #b91c1c; font-size: 0.75rem; font-weight: 600; padding: 4px 8px; border-radius: 6px; }
        body.dark-mode .missing-badge { background: #7f1d1d; color: #fca5a5; }
        .warning-badge { background: #fff7ed; color: #c2410c; border: 1px solid #ffedd5; font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 6px; display:inline-flex; align-items:center; gap:4px; }
        body.dark-mode .warning-badge { background: #7c2d12; color: #fdba74; border-color: #9a3412; }

        /* MODALE STATISTICHE */
        #stats-modal { display: none; position: fixed; inset: 0; background: var(--bg-card); z-index: 4000; flex-direction: column; overflow: hidden; animation: slideInRight 0.3s ease; }
        #stats-modal.open { display: flex; }
        @keyframes slideInRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .stats-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); background: var(--bg-card); }
        .stats-body { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg); -webkit-overflow-scrolling: touch; }
        
        .driver-list-item { padding: 18px; border-bottom: 1px solid var(--border); font-weight: 700; color: var(--text-main); cursor: pointer; display: flex; justify-content: space-between; align-items: center; background: var(--bg-card); margin-bottom: 10px; border-radius: 14px; box-shadow: var(--shadow-soft); transition: 0.2s; }
        .driver-list-item:active { transform: scale(0.98); background: var(--bg); }
        
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 10px; }
        .stat-card { background: var(--bg-card); padding: 16px; border-radius: 18px; border: 1px solid var(--border); text-align: center; box-shadow: var(--shadow-soft); display:flex; flex-direction:column; justify-content:center; }
        .stat-val { font-size: 2rem; font-weight: 900; display: block; margin-bottom: 4px; line-height: 1; letter-spacing: -1px; color: var(--text-main); }
        .stat-lbl { font-size: 0.7rem; font-weight: 600; text-transform: uppercase; color: var(--text-sec); }
        
        /* Colori Card Statistiche */
        .sc-fer { color: var(--b-ferie); border-color: var(--bg-ferie); background: #fff7ed; }
        .sc-cong { color: var(--b-cong); border-color: var(--bg-cong); background: #fefce8; }
        .sc-perm { color: var(--b-perm); border-color: var(--bg-perm); background: #f0fdf4; }
        .sc-mal { color: #b91c1c; border-color: #fca5a5; background: #fef2f2; }
        .sc-fest { color: #0369a1; border-color: #7dd3fc; background: #f0f9ff; }
        .sc-rec { color: var(--b-rec); border-color: var(--bg-rec); background: #fdf2f8; }
        
    </style>
</head>
<body>

    <div id="loader">
        <div id="auto-loader">
            <div class="spinner"></div>
            <h3 style="color:var(--text-main); margin:0; font-size:1.1rem; font-weight:800">Inizializzazione...</h3>
            <p style="color:var(--text-sec); font-size:0.85rem; margin-top:8px">Lettura Turni 2026</p>
        </div>
        <div id="manual-upload">
            <p style="color:#ef4444; font-weight:bold; font-size:1.1rem; margin-bottom:10px">⚠️ File automatico non trovato</p>
            <p style="color:var(--text-sec); font-size:0.9rem; margin:0">Carica manualmente il file Excel</p>
            <label for="file-input" class="file-label">
                <span class="material-icons-round">upload_file</span>
                CARICA FILE (.xlsx)
            </label>
            <input type="file" id="file-input" accept=".xlsx">
        </div>
    </div>

    <div id="shift-modal" onclick="closeShiftModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header" id="modal-header-bg">
                <div class="header-text">
                    <h3 id="modal-title">TITOLO</h3>
                    <span id="modal-subtitle">Data del giorno</span>
                </div>
                <button class="btn-close-modal" onclick="closeShiftModal()">
                    <span class="material-icons-round">keyboard_arrow_down</span>
                </button>
            </div>
            <div class="modal-body" id="modal-list"></div>
        </div>
    </div>

    <div id="dinner-modal" onclick="closeDinnerModal(event)">
        <div class="modal-content" onclick="event.stopPropagation()" style="height:90vh; max-height:90vh;">
            <div class="modal-header" style="background:#fff7ed; border-bottom-color:#ffedd5;">
                <div class="header-text">
                    <h3 style="color:#ea580c"><span class="material-icons-round" style="margin-right:8px">restaurant</span> ORGANIZZA</h3>
                    <span style="color:#fb923c">Trova la data migliore</span>
                </div>
                <button class="btn-close-modal" onclick="closeDinnerModal()">
                    <span class="material-icons-round">close</span>
                </button>
            </div>
            <div class="modal-body" style="background:var(--bg-card); display:flex; flex-direction:column; height:100%;">
                
                <div id="dinner-step-1">
                    <div class="dinner-section-title">1. MESE</div>
                    <div class="month-selector" id="dinner-month-list"></div>

                    <div class="dinner-section-title">2. TIPO DI USCITA</div>
                    <div class="event-type-selector">
                        <div class="event-option active" id="opt-cena" onclick="setEventType('cena', this)">
                            <span class="material-icons-round">bedtime</span> CENA (Sera)
                        </div>
                        <div class="event-option" id="opt-pranzo" onclick="setEventType('pranzo', this)">
                            <span class="material-icons-round">wb_sunny</span> PRANZO (Giorno)
                        </div>
                    </div>

                    <div style="display:flex; justify-content:space-between; align-items:center; padding-right:20px;">
                        <div class="dinner-section-title">3. SELEZIONA COLLEGHI</div>
                        <button onclick="toggleAllDrivers()" style="background:none; border:none; color:var(--primary); font-weight:bold; cursor:pointer; font-size:0.8rem; padding:10px;">Tutti/Nessuno</button>
                    </div>
                    <div class="dinner-checkbox-list" id="dinner-driver-list"></div>

                    <div style="padding:0 20px 20px 20px;">
                        <button class="btn-find-dinner" onclick="calculateDinner()">
                            <span class="material-icons-round">search</span> CERCA DISPONIBILITÀ
                        </button>
                    </div>
                </div>

                <div id="dinner-step-2" style="display:none; padding-bottom:30px;">
                    <div style="padding:15px 20px; display:flex; align-items:center; gap:10px; cursor:pointer; color:var(--primary); font-weight:700" onclick="resetDinnerStep()">
                        <span class="material-icons-round">arrow_back</span> Torna ai filtri
                    </div>
                    <div id="dinner-results-container"></div>
                </div>

            </div>
        </div>
    </div>

    <div id="stats-modal">
        <div class="stats-header">
            <h3 style="margin:0; font-size:1.2rem; color:var(--text-main); display:flex; align-items:center; gap:10px;">
                <span class="material-icons-round">bar_chart</span> STATISTICHE
            </h3>
            <button class="btn-close-modal" onclick="closeStatsModal()">
                <span class="material-icons-round">close</span>
            </button>
        </div>
        <div class="stats-body" id="stats-container">
            </div>
    </div>

    <header>
        <div class="top-bar">
            <div class="logo">
                <img src="logo.png" style="height: 40px; width: auto; display:block;" alt="Logo" onerror="this.style.display='none'">
                TURNI 2026
            </div>
            <div class="right-controls">
                
                <button class="btn-action" onclick="toggleMenu()">
                    <span class="material-icons-round">widgets</span> ALTRO
                </button>
                <div id="menu-dropdown">
                    <div class="menu-item" onclick="toggleDarkMode()">
                        <span class="material-icons-round">dark_mode</span> Tema Scuro
                    </div>
                    <div class="menu-item" onclick="openDinnerModal()">
                        <span class="material-icons-round">restaurant</span> Organizza Uscita
                    </div>
                    <div class="menu-item" onclick="openStatsSelection()">
                        <span class="material-icons-round">bar_chart</span> Statistiche
                    </div>
                </div>

                <button class="btn-action btn-view" onclick="toggleView()" id="view-btn">
                    <span class="material-icons-round">smartphone</span>
                </button>
                <button class="btn-action btn-reset" onclick="vibrate(); location.reload()">
                    <span class="material-icons-round">refresh</span>
                </button>
            </div>
        </div>
        <div class="nav-scroller" id="month-nav"></div>
        <div class="driver-scroller" id="driver-nav"></div>
    </header>

    <div class="container">
        <table id="main-table">
            <thead><tr id="table-head"></tr></thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>

    <script>
        const FILE_NAME = "turni.xlsx?v=" + new Date().getTime(); 
        const MONTH_MAP = { "GENNAIO":0, "FEBBRAIO":1, "MARZO":2, "APRILE":3, "MAGGIO":4, "GIUGNO":5, "LUGLIO":6, "AGOSTO":7, "SETTEMBRE":8, "OTTOBRE":9, "NOVEMBRE":10, "DICEMBRE":11 };
        
        const HOLIDAYS = {
            "0-1": "CAPODANNO", "0-6": "EPIFANIA", "1-5": "S. AGATA",
            "2-25": "ARENGO", "3-1": "REGGENZA", "3-5": "PASQUA",
            "3-6": "LUN. ANGELO", "4-1": "1° MAGGIO", "5-4": "CORPUS DOM.",
            "6-28": "LIBERAZIONE", "7-15": "FERRAGOSTO", "8-3": "S. MARINO",
            "9-1": "REGGENZA", "10-1": "OGNISSANTI", "10-2": "COMM. DEFUNTI",
            "11-8": "IMMACOLATA", "11-25": "NATALE", "11-26": "S. STEFANO"
        };

        const SCHEDULE = {
            "M": "6:30-13:15", "MAT": "6:30-13:15", "MATTINA": "6:30-13:15",
            "P": "12:45-20:10", "POM": "12:45-20:10", "POMERIGGIO": "12:45-20:10",
            "N": "19:45-00:00", "NOTT": "19:45-00:00", "NOTTE": "19:45-00:00",
            "SM": "00:00-7:20", "SMONTO": "00:00-7:20", "S": "00:00-7:20", 
            "R": "RIPOSO", "RIP": "RIPOSO"
        };

        let finalData = [];
        let drivers = [];
        let currentDriverFilter = "all";

        // GESTIONE DARK MODE IMMEDIATA
        if(localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
            document.querySelector('#theme-color-meta').setAttribute('content', '#0f172a');
        }

        // --- GESTIONE OTTIMIZZAZIONE MOBILE/PC ---
        function checkResponsiveView() {
            // Se lo schermo è stretto (cellulare), forza vista MOBILE (rimuove desktop-view)
            if (window.innerWidth < 1024) {
                document.body.classList.remove('desktop-view');
                updateViewButtonText(true);
            } else {
                // Su schermi grandi, metti PC view
                document.body.classList.add('desktop-view');
                updateViewButtonText(false);
            }
        }
        
        function updateViewButtonText(isMobile) {
            const btn = document.getElementById('view-btn');
            if(isMobile) {
                btn.innerHTML = '<span class="material-icons-round">smartphone</span> MOBILE';
                btn.style.backgroundColor = "var(--border)";
            } else {
                btn.innerHTML = '<span class="material-icons-round">desktop_windows</span> PC';
                btn.style.backgroundColor = "var(--bg-card)";
            }
        }

        function vibrate() {
            if(navigator.vibrate) navigator.vibrate(10);
        }

        function toggleMenu() {
            vibrate();
            let m = document.getElementById('menu-dropdown');
            if(m.style.display === 'flex') {
                m.classList.remove('open');
                setTimeout(() => m.style.display = 'none', 100);
            } else {
                m.style.display = 'flex';
                setTimeout(() => m.classList.add('open'), 10);
            }
        }

        function toggleDarkMode() {
            vibrate();
            document.body.classList.toggle('dark-mode');
            const meta = document.querySelector('#theme-color-meta');
            
            if(document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                meta.setAttribute('content', '#0f172a');
            } else {
                localStorage.setItem('theme', 'light');
                meta.setAttribute('content', '#ffffff');
            }
            toggleMenu(); 
        }

        // Chiudi menu se clicchi fuori
        document.addEventListener('click', function(event) {
            let m = document.getElementById('menu-dropdown');
            let btn = document.querySelector('.btn-action[onclick="toggleMenu()"]');
            if (m.style.display === 'flex' && !m.contains(event.target) && !btn.contains(event.target)) {
                toggleMenu();
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
            .then(reg => console.log('Service Worker Registered'))
            .catch(err => console.log('SW Fail', err));
        }

        function toggleView() {
            vibrate();
            const body = document.body;
            body.classList.toggle('desktop-view');
            const isNowDesktop = body.classList.contains('desktop-view');
            updateViewButtonText(!isNowDesktop);
            scrollToToday(); 
        }

        window.onload = async () => {
            // Applica logica mobile/pc al caricamento
            checkResponsiveView();

            try {
                const response = await fetch(FILE_NAME);
                if (!response.ok) throw new Error("File mancante");
                const buffer = await response.arrayBuffer();
                loadWorkbook(buffer);
            } catch (e) {
                console.error(e);
                document.getElementById('auto-loader').style.display = 'none';
                document.getElementById('manual-upload').style.display = 'block';
            }
        };

        document.getElementById('file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = (evt) => loadWorkbook(evt.target.result);
            reader.readAsArrayBuffer(file);
        });

        async function loadWorkbook(buffer) {
            try {
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(buffer);
                let ws = workbook.getWorksheet("Foglio2") || workbook.worksheets[0];
                
                let rawData = [];
                ws.eachRow({ includeEmpty: true }, (row, rowNumber) => {
                    let rowData = [];
                    row.eachCell({ includeEmpty: true }, (cell, colNumber) => {
                        let val = cell.value;
                        if(typeof val === 'object' && val !== null) val = val.result || "";
                        let bg = null;
                        if(cell.fill && cell.fill.fgColor) {
                            bg = cell.fill.fgColor.argb;
                            if(!bg && cell.fill.fgColor.theme !== undefined) bg = "THEME_" + cell.fill.fgColor.theme; 
                        }
                        rowData[colNumber] = { v: val, c: bg };
                    });
                    rawData[rowNumber] = rowData;
                });

                finalData = convertHorizontalToVertical(rawData);
                document.getElementById('loader').style.opacity = '0';
                setTimeout(() => document.getElementById('loader').style.display = 'none', 500);
                initApp();
            } catch(e) {
                alert("Errore lettura file: " + e.message);
                document.getElementById('loader').innerHTML = `<h3 style="color:red">Errore File!</h3><p>${e.message}</p><button onclick="location.reload()">Riprova</button>`;
            }
        }

        function convertHorizontalToVertical(raw) {
            let processed = [];
            let header = ["MESE", "GIORNO", "NOME"];
            let driverRows = [];
            
            for(let r=3; r<raw.length; r++) {
                if(!raw[r]) continue;
                let cellName = raw[r][1]; 
                
                if(cellName && cellName.v && typeof cellName.v === 'string') {
                    let txt = cellName.v.toUpperCase();
                    // Filtro legenda e testi inutili
                    if(txt.includes("CONGEDO") || txt.includes("MALATTIA") || txt.includes("RESIDUE") || 
                       txt.includes("P.S.") || txt.includes("RECUPERO") || txt.includes("PERM.") || 
                       txt.includes("ASPETTATIVA") || txt.includes("FEST.") || txt.includes("DISTACCO") || 
                       txt.includes("1>7") || txt.includes("P/PN")) {
                        continue; 
                    }
                }
                
                if(cellName && cellName.v && typeof cellName.v === 'string' && cellName.v.length > 2) {
                    let driverObj = { name: cellName.v, idx: r, subIdx: null };
                    if(raw[r+1] && (!raw[r+1][1] || !raw[r+1][1].v || raw[r+1][1].v.toString().trim() === "")) {
                        driverObj.subIdx = r + 1; 
                    }
                    driverRows.push(driverObj);
                    header.push(cellName.v);
                }
            }
            processed.push(header);

            let rowMese = raw[1];
            let rowGiorno = raw[2];
            let currentMonth = "";

            if(rowGiorno) {
                for(let c=2; c<rowGiorno.length; c++) {
                    let cellDay = rowGiorno[c];
                    let cellMese = rowMese ? rowMese[c] : null;
                    let dayNum = cellDay ? cellDay.v : null;
                    
                    if(cellMese && cellMese.v && typeof cellMese.v === 'string') {
                        let parts = cellMese.v.split("."); 
                        if(parts[0]) currentMonth = parts[0].trim().toUpperCase();
                    }

                    if(dayNum && !isNaN(parseInt(dayNum))) {
                        let newRow = [{v:currentMonth}, {v:dayNum}, {v:""}];
                        driverRows.forEach(dr => {
                            let mainData = raw[dr.idx][c] || {v:"", c:null};
                            let subData = dr.subIdx ? (raw[dr.subIdx][c] || {v:"", c:null}) : {v:"", c:null};
                            newRow.push({ v: mainData.v, c: mainData.c, subV: subData.v, subC: subData.c });
                        });
                        processed.push(newRow);
                    }
                }
            }
            return processed;
        }

        function initApp() {
            let header = finalData[0];
            drivers = [];
            for(let i=3; i<header.length; i++) {
                let name = header[i].toUpperCase();
                drivers.push({name: name, idx: i});
            }
            const drvNav = document.getElementById('driver-nav');
            drvNav.innerHTML = "";
            let btnAll = document.createElement('div');
            btnAll.className = "chip chip-driver active";
            btnAll.innerText = "TUTTI";
            btnAll.dataset.idx = "all";
            btnAll.onclick = () => filterDriver("all", btnAll);
            drvNav.appendChild(btnAll);

            drivers.forEach(d => {
                let btn = document.createElement('div');
                btn.className = "chip chip-driver";
                btn.innerText = d.name;
                btn.dataset.idx = d.idx;
                btn.onclick = () => filterDriver(d.idx, btn);
                drvNav.appendChild(btn);
            });

            let savedDr = localStorage.getItem("last_driver_view_v2");
            if(savedDr) {
                currentDriverFilter = savedDr;
                updateDriverButtons(savedDr);
            }
            renderTable();
            startLiveClock();
            
            setTimeout(scrollToToday, 600);
        }

        function scrollToToday() {
            const el = document.getElementById('today-row');
            if (el) {
                const headerHeight = document.body.classList.contains('desktop-view') ? 130 : 160;
                const extraOffset = 100; 
                
                const bodyRect = document.body.getBoundingClientRect().top;
                const elementRect = el.getBoundingClientRect().top;
                const elementPosition = elementRect - bodyRect;
                
                const offsetPosition = elementPosition - headerHeight - extraOffset;

                window.scrollTo({
                    top: offsetPosition,
                    behavior: "smooth"
                });
            }
        }

        function filterDriver(val, btnEl) {
            vibrate();
            currentDriverFilter = val;
            localStorage.setItem("last_driver_view_v2", val);
            document.querySelectorAll('.chip-driver').forEach(b => b.classList.remove('active'));
            if(btnEl) btnEl.classList.add('active');
            renderTable();
        }

        function updateDriverButtons(val) {
             document.querySelectorAll('.chip-driver').forEach(b => {
                 b.classList.remove('active');
                 if(b.dataset.idx == val) b.classList.add('active');
             });
        }

        function startLiveClock() {
            setInterval(() => {
                const now = new Date();
                const dateStr = now.toLocaleDateString('it-IT', { weekday: 'short', day: 'numeric', month: 'short' });
                const timeStr = now.toLocaleTimeString('it-IT', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const fullStr = `${dateStr} • ${timeStr}`;
                
                document.querySelectorAll('.live-clock').forEach(el => {
                    el.innerText = fullStr;
                });
            }, 1000);
        }

        function renderTable() {
            const thead = document.getElementById('table-head');
            const tbody = document.getElementById('table-body');
            const nav = document.getElementById('month-nav');
            thead.innerHTML = ""; tbody.innerHTML = ""; nav.innerHTML = "";

            let cols = (currentDriverFilter === "all") ? drivers : drivers.filter(d => d.idx == parseInt(currentDriverFilter));

            let thD = document.createElement('th'); thD.innerText = "DATA"; 
            thD.style.left = "0"; thD.style.zIndex="95"; thead.appendChild(thD);

            cols.forEach(d => {
                let th = document.createElement('th'); th.innerText = d.name; thead.appendChild(th);
            });

            let currentMonth = "";
            let monthsFound = [];
            let year = 2026;
            const today = new Date();
            const curD = today.getDate(); const curM = today.getMonth();

            for(let i = 1; i < finalData.length; i++) {
                let row = finalData[i];
                let mName = row[0].v;
                let dNum = parseInt(row[1].v);

                if(mName && mName !== currentMonth) {
                    currentMonth = mName;
                    let mId = "m-" + i;
                    monthsFound.push({name: mName, id: mId});
                    let trM = document.createElement('tr'); trM.className = "month-header";
                    trM.id = mId;
                    
                    trM.innerHTML = `
                    <td colspan="${cols.length + 1}">
                        <div class="sticky-month-text">
                            <span class="month-label">${mName} ${year}</span>
                            <span class="live-clock"></span>
                        </div>
                    </td>`;
                    tbody.appendChild(trM);
                }

                let tr = document.createElement('tr');
                let mIdx = MONTH_MAP[currentMonth];
                
                // DATA
                let dateObj = new Date(year, mIdx, dNum);
                let dayWeek = dateObj.toLocaleDateString('it-IT', { weekday: 'short' }).toUpperCase();
                let dayIdx = dateObj.getDay(); 
                let holKey = `${mIdx}-${dNum}`;
                let holidayName = HOLIDAYS[holKey];
                
                let isRed = (dayIdx === 0 || dayIdx === 6 || holidayName);
                let dateClass = isRed ? "td-date date-red" : "td-date";
                
                if(mIdx === curM && dNum === curD && today.getFullYear() === year) {
                    tr.className = "today";
                    tr.id = "today-row";
                }

                let dateHtml = `
                    ${dNum}
                    <small>${dayWeek}</small>
                    ${holidayName ? `<div class="holiday-name">${holidayName}</div>` : ""}
                `;
                
                tr.innerHTML = `<td class="${dateClass}">${dateHtml}</td>`;

                cols.forEach(d => {
                    let cellInfo = row[d.idx];
                    let td = document.createElement('td');
                    td.innerHTML = formatCell(cellInfo);
                    
                    let rawVal = cellInfo.v ? cellInfo.v.toString().trim() : "";
                    let shiftType = normalizeShift(rawVal);
                    if(["M", "P", "N", "R"].includes(shiftType)) {
                        td.onclick = () => openShiftModal(i, shiftType, mName, dNum, dayWeek);
                    }
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            }

            monthsFound.forEach(m => {
                let btn = document.createElement('div');
                btn.className = "chip chip-month";
                btn.innerText = m.name.substr(0,3);
                btn.onclick = () => {
                    vibrate();
                    document.querySelectorAll('.chip-month').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    const el = document.getElementById(m.id);
                    const headerHeight = document.body.classList.contains('desktop-view') ? 130 : 160;
                    const bodyRect = document.body.getBoundingClientRect().top;
                    const elementRect = el.getBoundingClientRect().top;
                    const elementPosition = elementRect - bodyRect;
                    const offset = elementPosition - headerHeight;
                    window.scrollTo({ top: offset, behavior: "smooth" });
                };
                nav.appendChild(btn);
            });
        }

        function normalizeShift(val) {
            let u = val.toUpperCase();
            if(u === "M" || u.startsWith("MAT") || u === "M/R") return "M";
            if(u === "P" || u.startsWith("POM")) return "P";
            if(u === "N" || u.startsWith("NOT")) return "N";
            if(u === "R" || u.startsWith("RIP")) return "R";
            return "";
        }

        function openShiftModal(rowIndex, shiftType, month, day, weekDay) {
            vibrate();
            let row = finalData[rowIndex];
            let list = document.getElementById('modal-list');
            let title = document.getElementById('modal-title');
            let sub = document.getElementById('modal-subtitle');
            let modalContent = document.querySelector('#shift-modal .modal-content');
            
            modalContent.classList.remove('modal-theme-M', 'modal-theme-P', 'modal-theme-N', 'modal-theme-R');
            modalContent.classList.add('modal-theme-' + shiftType);
            list.innerHTML = "";
            
            let fullShiftName = "";
            let iconHtml = "";
            if(shiftType === "M") { fullShiftName = "MATTINA"; iconHtml = '<span class="material-icons-round">wb_sunny</span>'; }
            if(shiftType === "P") { fullShiftName = "POMERIGGIO"; iconHtml = '<span class="material-icons-round">wb_twilight</span>'; }
            if(shiftType === "N") { fullShiftName = "NOTTE"; iconHtml = '<span class="material-icons-round">bedtime</span>'; }
            if(shiftType === "R") { fullShiftName = "RIPOSO"; iconHtml = '<span class="material-icons-round">weekend</span>'; }

            title.innerHTML = `${iconHtml} ${fullShiftName}`;
            sub.innerText = `${weekDay} ${day} ${month}`;
            
            let found = 0;
            drivers.forEach(d => {
                let cellData = row[d.idx];
                let val = cellData.v ? cellData.v.toString().trim() : "";
                
                if(normalizeShift(val) === shiftType) {
                    found++;
                    let time = "";
                    
                    if(val === "m" || val.startsWith('m')) time = "6:30-13:42";
                    else if(val === "p" || val.startsWith('p')) time = "13:15-20:27"; 

                    else if(val === "M/R") time = "6:30-13:15";
                    else time = SCHEDULE[val] || SCHEDULE[val.toUpperCase()] || SCHEDULE[val.charAt(0).toUpperCase()] || "";

                    if(shiftType === "R") time = "Riposo"; 
                    
                    let isRep = (val.toLowerCase().includes("/r") || val === "M/R");
                    let repTag = isRep ? `<span class="rep-badge" style="margin-left:8px">REP</span>` : "";

                    let div = document.createElement('div');
                    div.className = "colleague-item";
                    div.innerHTML = `<span class="c-name">${d.name} ${repTag}</span><span class="c-time">${time}</span>`;
                    list.appendChild(div);
                }
            });
            
            if(found === 0) list.innerHTML = "<div style='text-align:center; color:var(--text-sec); padding:30px; font-weight:500'>Nessun altro collega in questo turno.</div>";
            let modal = document.getElementById('shift-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
        }

        function closeShiftModal(e) {
            if (e && e.target !== e.currentTarget) return; 
            let modal = document.getElementById('shift-modal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 200);
        }

        /* --- LOGICA MODALE CENA/EVENTO --- */
        let dinnerSelectedMonth = "";
        let eventType = "cena"; // 'cena' o 'pranzo'
        
        function openDinnerModal() {
            toggleMenu(); 
            let modal = document.getElementById('dinner-modal');
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('open'), 10);
            
            resetDinnerStep();

            let mList = document.getElementById('dinner-month-list');
            mList.innerHTML = "";
            let months = Object.keys(MONTH_MAP);
            months.forEach(m => {
                let c = document.createElement('div');
                c.className = "chip chip-month";
                c.innerText = m.substr(0,3);
                c.onclick = () => {
                    vibrate();
                    document.querySelectorAll('#dinner-month-list .chip-month').forEach(x => x.classList.remove('active'));
                    c.classList.add('active');
                    dinnerSelectedMonth = m;
                };
                mList.appendChild(c);
            });
            
            if(!dinnerSelectedMonth) {
                let curMName = months[new Date().getMonth()];
                let chips = mList.getElementsByClassName('chip-month');
                if(chips[new Date().getMonth()]) chips[new Date().getMonth()].click();
            }

            let dList = document.getElementById('dinner-driver-list');
            if(dList.children.length === 0) { 
                drivers.forEach(d => {
                    let item = document.createElement('label');
                    item.className = "dinner-check-item checked"; 
                    item.innerHTML = `
                        <input type="checkbox" value="${d.idx}" checked onchange="this.parentElement.classList.toggle('checked'); vibrate()">
                        <div class="dinner-check-icon"><span class="material-icons-round" style="font-size:14px">check</span></div>
                        ${d.name}
                    `;
                    dList.appendChild(item);
                });
            }
        }

        function setEventType(type, el) {
            vibrate();
            eventType = type;
            document.querySelectorAll('.event-option').forEach(e => e.classList.remove('active'));
            el.classList.add('active');
        }

        function toggleAllDrivers() {
            vibrate();
            let checks = document.querySelectorAll('#dinner-driver-list input[type="checkbox"]');
            let allChecked = Array.from(checks).every(c => c.checked);
            checks.forEach(c => {
                c.checked = !allChecked;
                if(!allChecked) c.parentElement.classList.add('checked');
                else c.parentElement.classList.remove('checked');
            });
        }

        function closeDinnerModal(e) {
            if (e && e.target !== e.currentTarget) return;
            let modal = document.getElementById('dinner-modal');
            modal.classList.remove('open');
            setTimeout(() => { modal.style.display = 'none'; }, 200);
        }
        
        function resetDinnerStep() {
            document.getElementById('dinner-step-1').style.display = 'block';
            document.getElementById('dinner-step-2').style.display = 'none';
        }

        function calculateDinner() {
            vibrate();
            if(!dinnerSelectedMonth) { alert("Seleziona un mese!"); return; }
            
            let selectedDriversIdx = [];
            document.querySelectorAll('#dinner-driver-list input:checked').forEach(c => {
                selectedDriversIdx.push(parseInt(c.value));
            });
            
            if(selectedDriversIdx.length === 0) { alert("Seleziona almeno un collega!"); return; }

            let results = [];
            
            for(let i=1; i<finalData.length; i++) {
                let row = finalData[i];
                if(row[0].v !== dinnerSelectedMonth) continue;
                
                let dayNum = row[1].v;
                let mIdx = MONTH_MAP[dinnerSelectedMonth];
                let dateObj = new Date(2026, mIdx, dayNum);
                let dayWeek = dateObj.toLocaleDateString('it-IT', { weekday: 'long' });
                
                let availableCount = 0;
                let missingNames = [];
                let reperibiliNames = [];
                
                selectedDriversIdx.forEach(dIdx => {
                    let cellData = row[dIdx];
                    let val = cellData.v ? cellData.v.toString().trim().toUpperCase() : "";
                    
                    let isBusy = false;
                    let isRep = (val.toLowerCase().includes("/r") || row[dIdx].subV === "R");

                    if(val === "MALATTIA" || val === "MAL" || val === "M" || val === "ASP" || val.includes("CONG") || val === "F") {
                        isBusy = true;
                    } 
                    else if(eventType === 'cena') {
                        if(val.startsWith("N") || val === "NOT") isBusy = true;
                    } else {
                        if(val.startsWith("P") || val === "POM") isBusy = true;
                    }

                    if(isBusy) {
                        let dName = drivers.find(d => d.idx === dIdx).name;
                        missingNames.push(dName);
                    } else {
                        availableCount++;
                        if(isRep) {
                            let dName = drivers.find(d => d.idx === dIdx).name;
                            reperibiliNames.push(dName);
                        }
                    }
                });
                
                results.push({
                    day: dayNum,
                    weekDay: dayWeek,
                    score: availableCount,
                    total: selectedDriversIdx.length,
                    missing: missingNames,
                    reperibili: reperibiliNames
                });
            }
            
            results.sort((a, b) => {
                if(b.score !== a.score) return b.score - a.score;
                let isWeA = (a.weekDay === "venerdì" || a.weekDay === "sabato");
                let isWeB = (b.weekDay === "venerdì" || b.weekDay === "sabato");
                if(isWeA && !isWeB) return -1;
                if(!isWeA && isWeB) return 1;
                return 0;
            });
            
            let resContainer = document.getElementById('dinner-results-container');
            let eventName = (eventType === 'cena') ? "CENE" : "PRANZI";
            resContainer.innerHTML = `<h4 style="margin:0 20px 15px; color:var(--text-sec)">TOP 10 DATE PER ${eventName} - ${dinnerSelectedMonth}</h4>`;
            
            results.slice(0, 10).forEach(res => {
                let div = document.createElement('div');
                div.className = "dinner-result-card";
                
                let missingHtml = res.missing.length > 0 
                    ? res.missing.map(n => `<span class="missing-badge">${n}</span>`).join("") 
                    : "";

                let repHtml = res.reperibili.length > 0
                    ? res.reperibili.map(n => `<span class="warning-badge">👮‍♂️ ${n}</span>`).join("")
                    : "";
                
                let conflictLabel = (eventType === 'cena') ? "Turno N" : "Turno P";

                let allFreeHtml = "";
                if(res.missing.length === 0) {
                    allFreeHtml = `<div style="text-align:center; color:#15803d; font-size:0.95rem; font-weight:800; padding:8px; margin-top:5px; background:#dcfce7; border-radius:8px">TUTTI LIBERI! 🥂</div>`;
                }

                div.innerHTML = `
                    <div class="d-res-header">
                        <span class="d-res-date">${res.weekDay} ${res.day}</span>
                        <span class="d-res-score">${res.score} / ${res.total}</span>
                    </div>
                    
                    ${allFreeHtml}

                    ${repHtml ? `<div style="font-size:0.75rem; color:#c2410c; margin:10px 0 4px; font-weight:700;">IN SERVIZIO / REPERIBILI:</div>
                    <div class="missing-list" style="margin-bottom:10px;">${repHtml}</div>` : ""}

                    ${missingHtml ? `<div style="font-size:0.75rem; color:var(--text-sec); margin-bottom:4px;">ASSENTI (${conflictLabel}):</div>
                    <div class="missing-list">${missingHtml}</div>` : ""}
                `;
                resContainer.appendChild(div);
            });
            
            document.getElementById('dinner-step-1').style.display = 'none';
            document.getElementById('dinner-step-2').style.display = 'block';
        }

        // --- GESTIONE STATISTICHE ---
        
        function openStatsSelection() {
            toggleMenu(); 
            let container = document.getElementById('stats-container');
            container.innerHTML = "";
            let h3 = document.querySelector('.stats-header h3');
            h3.innerHTML = "<span class='material-icons-round'>person_search</span> SELEZIONA AUTISTA";
            h3.style.color = "var(--text-main)";

            drivers.forEach(d => {
                let div = document.createElement('div');
                div.className = "driver-list-item";
                div.innerHTML = `<span>${d.name}</span><span class="material-icons-round" style="color:var(--text-sec)">chevron_right</span>`;
                div.onclick = () => { vibrate(); showDriverStats(d); };
                container.appendChild(div);
            });

            document.getElementById('stats-modal').classList.add('open');
        }

        function closeStatsModal() {
            document.getElementById('stats-modal').classList.remove('open');
        }

        function showDriverStats(driver) {
            let container = document.getElementById('stats-container');
            let h3 = document.querySelector('.stats-header h3');
            h3.innerHTML = `<span class='material-icons-round'>account_circle</span> ${driver.name}`;
            h3.style.color = "var(--primary)";

            let stats = {
                ferie: 0, congedo: 0, permessi: 0, recupero: 0, malattia: 0, festNonGod: 0,
                mattine: 0, pomeriggi: 0, notti: 0
            };

            for(let i=1; i<finalData.length; i++) {
                let row = finalData[i];
                let cellData = row[driver.idx];
                if(!cellData) continue;

                let val = cellData.v ? cellData.v.toString().trim() : "";
                let color = cellData.c || "";
                let subColor = cellData.subC || "";
                let subVal = cellData.subV ? cellData.subV.toString().trim().toUpperCase() : "";
                let u = val.toUpperCase();

                let matched = false;

                if(u === "NL" || subVal === "NL") { stats.festNonGod++; matched=true; }
                if(subVal === "NG") { stats.festNonGod++; matched=true; }
                if(subVal === "M") { stats.malattia++; matched=true; }
                if(matched) continue;

                if(subColor && subColor.length >= 6) {
                    let cat = detectColorCategory(subColor);
                    if(cat) {
                        if(cat.lbl === "MALATTIA") { stats.malattia++; matched=true; }
                        else if(cat.lbl.includes("FESTIVO")) { stats.festNonGod++; matched=true; }
                    }
                }
                if(matched) continue;

                if(color && color.length >= 6) {
                    let cat = detectColorCategory(color);
                    if(cat) {
                        if(cat.lbl.includes("PERMESSO")) { stats.permessi++; matched=true; }
                        else if(cat.lbl.includes("CONGEDO")) { stats.congedo++; matched=true; }
                        else if(cat.lbl.includes("FERIE")) { stats.ferie++; matched=true; }
                        else if(cat.lbl.includes("RECUPERO")) { stats.recupero++; matched=true; }
                        else if(cat.lbl.includes("FESTIVO")) { stats.festNonGod++; matched=true; }
                    }
                }
                if(matched) continue;

                if(u.includes("FER") || subVal.includes("FER")) stats.ferie++;
                else if(u.includes("CONG") || subVal.includes("CONG")) stats.congedo++;
                else if(u.includes("REC") || subVal.includes("REC") || subVal === "R") stats.recupero++; 
                else if(u.includes("PER") || subVal.includes("PER")) stats.permessi++;
                
                else if(u.startsWith("M") || val === "m") stats.mattine++;
                else if(u.startsWith("P") || val === "p") stats.pomeriggi++;
                else if(u.startsWith("N")) stats.notti++;
            }

            container.innerHTML = `
                <div class="driver-list-item" onclick="openStatsSelection()" style="background:var(--bg); color:var(--text-sec); margin-bottom:20px; border:none;">
                    <span style="display:flex; align-items:center; gap:10px;"><span class="material-icons-round">arrow_back</span> TORNA ALLA LISTA</span>
                </div>
                
                <h4 style="margin:0 0 10px 0; color:var(--text-sec); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px">Assenze & Permessi</h4>
                <div class="stats-grid">
                    <div class="stat-card sc-fer">
                        <span class="stat-val" style="color:#a15300">${stats.ferie}</span>
                        <span class="stat-lbl">Ferie Residue</span>
                    </div>
                    <div class="stat-card sc-cong">
                        <span class="stat-val" style="color:#000000">${stats.congedo}</span>
                        <span class="stat-lbl">Congedi Ord.</span>
                    </div>
                    <div class="stat-card sc-perm">
                        <span class="stat-val" style="color:#004e1c">${stats.permessi}</span>
                        <span class="stat-lbl">Permessi Str.</span>
                    </div>
                    <div class="stat-card sc-rec">
                        <span class="stat-val" style="color:#c3006b">${stats.recupero}</span>
                        <span class="stat-lbl">Recuperi</span>
                    </div>
                    <div class="stat-card sc-mal">
                        <span class="stat-val" style="color:#b91c1c">${stats.malattia}</span>
                        <span class="stat-lbl">Malattia</span>
                    </div>
                    <div class="stat-card sc-fest">
                        <span class="stat-val" style="color:#0369a1">${stats.festNonGod}</span>
                        <span class="stat-lbl">Fest. Non God.</span>
                    </div>
                </div>

                <h4 style="margin:25px 0 10px 0; color:var(--text-sec); font-size:0.8rem; text-transform:uppercase; letter-spacing:1px">Turni Svolti</h4>
                <div class="stats-grid" style="grid-template-columns: 1fr 1fr 1fr;">
                    <div class="stat-card" style="border-color:var(--b-M); background:var(--c-M); color:var(--t-M);">
                        <span class="stat-val" style="color:white">${stats.mattine}</span>
                        <span class="stat-lbl" style="opacity:0.9; color:white">Mattine</span>
                    </div>
                    <div class="stat-card" style="border-color:var(--b-P); background:var(--c-P); color:var(--t-P);">
                        <span class="stat-val" style="color:white">${stats.pomeriggi}</span>
                        <span class="stat-lbl" style="opacity:0.9; color:white">Pomeriggi</span>
                    </div>
                    <div class="stat-card" style="border-color:var(--b-N); background:var(--c-N); color:white;">
                        <span class="stat-val" style="color:white">${stats.notti}</span>
                        <span class="stat-lbl" style="color:#cbd5e1">Notti</span>
                    </div>
                </div>
            `;
        }

        // --- RICONOSCIMENTO COLORI ---
        function detectColorCategory(argb) {
            if(!argb || argb.length < 8) return null;
            let r = parseInt(argb.substring(2, 4), 16);
            let g = parseInt(argb.substring(4, 6), 16);
            let b = parseInt(argb.substring(6, 8), 16);
            
            if(isNaN(r) || isNaN(g) || isNaN(b)) return null;

            // 1. ROSSO (Malattia)
            if (r > g + 40 && r > b + 40) return { lbl: "MALATTIA", cls: "spec-red" };

            // 2. BLU/CIANO (Festivo non goduto)
            let blueDominant = (b > r + 40 && b > g + 40);
            let cyanDominant = (b > r + 40 && g > r + 40); 
            if (blueDominant || cyanDominant) return { lbl: "FESTIVO<br>NON GODUTO", cls: "spec-blue" };

            // 3. VERDE (Permesso)
            if (g > r && g > b) return { lbl: "PERMESSO<br>STRAORD.", cls: "spec-green" };
            
            // 4. GIALLO/ARANCIO (Congedo/Ferie)
            if (r > b && r > g) {
                if (g > 180 && g >= r * 0.8) return { lbl: "CONGEDO<br>ORDINARIO", cls: "spec-yellow" };
                if (g > 80 && g < r * 0.8) return { lbl: "FERIE<br>RESIDUE", cls: "spec-orange" };
            }
            
            // 5. VIOLA/ROSA (Recupero)
            if ((r > 150 && b > 100) || (r > g && b > g)) return { lbl: "RECUPERO", cls: "spec-pink" };
            
            return null; 
        }

        function formatCell(info) {
            let val = info.v ? info.v.toString().trim() : "";
            let color = info.c || "";
            let subColor = info.subC || ""; 
            let u = val.toUpperCase();
            let subVal = info.subV ? info.subV.toString().trim().toUpperCase() : "";

            if(u === "NL" || subVal === "NL") return renderSpecial("FESTIVO<br>NON LAVORATO", "spec-nl");

            if(subVal === "NG") return renderSpecial("FESTIVO<br>NON GODUTO", "spec-blue");
            if(subVal === "M") return renderSpecial("MALATTIA", "spec-red");
            
            if (subColor && !subColor.startsWith('FFFFFFFF') && subColor !== 'FF000000' && subColor.length >= 6) {
                let subCat = detectColorCategory(subColor);
                if (subCat && (subCat.cls === "spec-blue" || subCat.cls === "spec-red")) {
                    return `<div class="cell ${subCat.cls}">${subCat.lbl}</div>`;
                }
            }

            let hasColor = (color && !color.startsWith('FFFFFFFF') && color !== 'FF000000' && color.length >= 6); 
            if(hasColor) {
                let cat = detectColorCategory(color);
                if(cat) return `<div class="cell ${cat.cls}">${cat.lbl}</div>`;
            }

            let isEmpty = (val === "-" || val === "." || val === "0" || val === "");
            
            if(subVal === "F" || subVal.includes("CONG")) return renderSpecial("CONGEDO<br>ORDINARIO", "spec-yellow");
            if(subVal === "V" || subVal.includes("FER")) return renderSpecial("FERIE<br>RESIDUE", "spec-orange");
            if(subVal === "R" || subVal.includes("REC")) return renderSpecial("RECUPERO", "spec-pink");
            if(subVal === "P" || subVal.includes("PER")) return renderSpecial("PERMESSO<br>STRAORD.", "spec-green");
            
            if(u === "F" || u.includes("CONG")) return `<div class="cell spec-yellow">CONGEDO<br>ORDINARIO</div>`;
            if(u === "V" || u.includes("FER")) return `<div class="cell spec-orange">FERIE<br>RESIDUE</div>`;
            if(u.includes("REC")) return `<div class="cell spec-pink">RECUPERO</div>`;
            if(u.includes("PERM")) return `<div class="cell spec-green">PERMESSO<br>STRAORD.</div>`;
            
            if(isEmpty) return `<div class="cell empty">-</div>`;

            let display = u;
            let cls = "cell";
            let time = "";

            let rawVal = val.trim();
            let firstChar = rawVal.charAt(0);

            if (firstChar === 'm' || firstChar === 'p') {
                if (firstChar === 'm') {
                      display = "MATTINA";
                      time = "6:30-13:42";
                } else {
                      display = "POMERIGGIO";
                      time = "13:15-20:27";
                }
                cls += " t-diurno"; 
            }
            else {
                if(u.startsWith("M")) { display = "MATTINA"; cls += " t-M"; }
                else if(u.startsWith("P")) { display = "POMERIGGIO"; cls += " t-P"; }
                else if(u.startsWith("N")) { display = "NOTTE"; cls += " t-N"; }
                else if(u.startsWith("R")) { display = "RIPOSO"; cls += " t-R"; }
                else if(u.startsWith("S")) { display = "SMONTO"; cls += " t-SM"; }
                else { cls += " empty"; }

                if (!time) {
                    if (SCHEDULE[val]) { time = SCHEDULE[val]; }
                    else if(SCHEDULE[u]) { time = SCHEDULE[u]; }
                    else if(SCHEDULE[val.charAt(0)]) { time = SCHEDULE[val.charAt(0)]; }
                }
            }

            let isRep = false;
            if (rawVal.toLowerCase().includes("/r")) isRep = true; 
            
            let repHtml = isRep ? `<div class="rep-badge">REPERIBILE</div>` : "";

            return `<div class="${cls}">
                <div>${display}</div>
                ${time ? `<div class="time-tag">${time}</div>` : ""}
                ${repHtml}
            </div>`;
        }

        function renderSpecial(text, cssClass) {
            return `<div class="cell ${cssClass}">${text}</div>`;
        }
    </script>
</body>
</html>